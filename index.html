<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pedidos YEMM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="styles/style.css">

</head>

<body class="d-flex flex-column min-vh-100">
  <!-- Header -->
  <header class="bg-light py-4 px-3 border-bottom shadow-sm">
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center flex-wrap">

        <!-- Logo -->
        <div class="d-flex align-items-center me-auto">
          <img src="images/LogoPedidos.png" alt="PEDIDOS YEMM" class="logo-img me-2" style="height: 60px;">
          <span class="fw-bold text-danger fs-4">PEDIDOS YEMM</span>
        </div>

        <!-- Bot√≥n Ver Carrito -->
        <button class="btn btn-outline-dark ms-4" data-bs-toggle="modal" data-bs-target="#carritoModal">
          <i class="bi bi-cart"></i> Ver Carrito
        </button>

        <!-- Search Bar + Direcci√≥n -->
        <div class="d-flex align-items-center flex-grow-1 justify-content-center">
          <button class="btn btn-outline-danger btn-ingresar-direccion" data-bs-toggle="modal"
            data-bs-target="#direccionModal">Ingresar direcci√≥n</button>
          <div class="input-group ms-3" style="max-width: 300px;">
            <input type="text" class="form-control rounded-pill" placeholder="Buscar locales">
            <button class="btn btn-danger rounded-pill ms-2">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <!-- Perfil -->
        <div class="d-flex align-items-center ms-3">
          <a href="#" class="text-dark" id="profileBtn" role="button">
            <i class="bi bi-person"></i> Mi Perfil
          </a>
        </div>

      </div>
    </div>

    <!-- Bot√≥n Panel Repartidor -->
    <button class="btn btn-outline-danger ms-3" data-bs-toggle="modal" data-bs-target="#repartidorModal"
      id="btnRepartidor" style="display:none;">
      <i class="bi bi-truck"></i> Panel Repartidor
    </button>
    <button class="btn btn-outline-primary ms-2" data-bs-toggle="modal" data-bs-target="#reportesModal" id="btnReportes"
      style="display:none;">
      <i class="bi bi-bar-chart"></i> Reportes
    </button>
    </div>


  </header>



  <div class="promo-marquee">
    <div class="promo-marquee-track">
      <span>üéâ ¬°Aprovecha nuestras promociones de lanzamiento! 2x1 en pizzas, bebidas gratis y mucho m√°s.
        üéâ</span>
      <span>üéâ ¬°Aprovecha nuestras promociones de lanzamiento! 2x1 en pizzas, bebidas gratis y mucho m√°s.
        üéâ</span>
    </div>
  </div>

  <!-- Modal para ingresar direcci√≥n -->
  <div class="modal fade" id="direccionModal" tabindex="-1" aria-labelledby="direccionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="direccionModalLabel">Ingresar Direcci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="direccionForm">
            <div class="mb-3">
              <label for="calle" class="form-label">Calle y n√∫mero</label>
              <input type="text" class="form-control" id="calle" placeholder="Ejemplo: Av. Siempre Viva 742">
            </div>
            <div class="mb-3">
              <label for="ciudad" class="form-label">Ciudad</label>
              <input type="text" class="form-control" id="ciudad" placeholder="Ejemplo: Cali">
            </div>
            <div class="mb-3">
              <label for="provincia" class="form-label">Departamento</label>
              <input type="text" class="form-control" id="departamento" placeholder="Ejemplo: Valle del Cauca">
            </div>
            <div class="mb-3">
              <label for="codigoPostal" class="form-label">C√≥digo Postal</label>
              <input type="text" class="form-control" id="codigoPostal" placeholder="Ejemplo: 1000">
            </div>

            <!-- botones: guardar/actualizar y eliminar (eliminar s√≥lo si ya hay direcci√≥n) -->
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-danger w-100" id="guardarDireccionBtn">Guardar Direcci√≥n</button>
              <button type="button" class="btn btn-outline-danger" id="eliminarDireccionBtn"
                style="display:none;">Eliminar direcci√≥n</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar sesi√≥n o Registrarse</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">Correo electr√≥nico</label>
              <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Contrase√±a</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <div id="registerFields" style="display:none;">
              <div class="mb-3">
                <label for="registerName" class="form-label">Nombre completo</label>
                <input type="text" class="form-control" id="registerName">
              </div>
            </div>
            <!-- Campo de tipo de usuario -->
            <div class="mb-3">
              <label for="userRole" class="form-label">Tipo de usuario</label>
              <select class="form-select" id="userRole" required>
                <option value="">Selecciona tu rol</option>
                <option value="cliente">Cliente</option>
                <option value="repartidor">Repartidor</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
            <div class="d-flex justify-content-between">
              <button type="submit" class="btn btn-danger" id="loginBtn">Iniciar sesi√≥n</button>
              <button type="button" class="btn btn-outline-secondary" id="toggleRegisterBtn">Registrarse</button>
            </div>
          </form>
          <div id="loginMessage" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nuevo Modal de Perfil de Usuario -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileModalLabel">Mi Perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-center">
          <div class="mb-3">
            <img id="profilePhoto" src="https://via.placeholder.com/90x90?text=Foto" class="rounded-circle mb-2"
              style="width:90px;height:90px;object-fit:cover;">
            <input type="file" id="photoInput" accept="image/*" class="form-control form-control-sm mx-auto"
              style="max-width:180px;">
          </div>
          <h6 id="profileName"></h6>
          <p id="profileEmail" class="mb-1"></p>
          <hr>
          <h6>Direcciones registradas</h6>
          <ul id="profileAddresses" class="list-group mb-3"></ul>
          <button class="btn btn-outline-danger btn-sm mb-2" id="logoutBtn">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Panel Repartidor (justo despu√©s de #profileModal) -->
  <div class="modal fade" id="repartidorModal" tabindex="-1" aria-labelledby="repartidorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="repartidorModalLabel">Panel Repartidor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="repartidorPedidosList" class="list-group"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Reportes (solo admin) -->
  <div class="modal fade" id="reportesModal" tabindex="-1" aria-labelledby="reportesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportesModalLabel">Reportes de Ventas y Clientes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <h6>Ingresos mensuales por tienda</h6>
          <div id="tablaIngresos"></div>
          <hr>
          <h6>Clientes frecuentes por tienda</h6>
          <div id="tablaClientes"></div>
        </div>
        <hr>
        <h6>Cobertura geogr√°fica</h6>
        <div id="tablaCobertura"></div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>


        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="container my-5 flex-fill">
    <!-- Imagen de fondo -->
    <section class="hero-bg mb-5 position-relative">
      <img src="images/fondo.jpg" alt="Fondo" class="w-100 hero-img">
      <div class="hero-text hero-text-left">
        <h1 class="display-6 fw-bold text-white mb-3">
          ¬°Bienvenido a <span style="color:#ffd600;">PEDIDOS YEMM</span>!
        </h1>
        <p class="lead text-white mb-1" style="max-width: 600px;">
          Descubre los mejores sabores de tu ciudad. <span style="color:#ffd600;">Promociones
            exclusivas</span>, <span style="color:#ffd600;">entrega r√°pida</span> y <span style="color:#ffd600;">tus
            restaurantes favoritos</span> a solo un clic.
        </p>
        <a href="#te-sugerimos" class="btn btn-warning btn-lg fw-bold shadow mt-0">Explora opciones</a>
      </div>
    </section>

    <!-- Secci√≥n de categor√≠as (modificada para ser clicable) -->
    <section class="seccion-categorias py-5"
      style="margin-top:0; width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw;">
      <h2 class="titulo-antojo">¬øQu√© se te antoja hoy?</h2>
      <div class="row justify-content-center text-center g-4">
        <div class="col-md-2">
          <div class="categoria-card" role="button" data-categoria="hamburguesas" style="cursor:pointer">
            <img src="images/Hamburguesa.jpg" alt="Hamburguesas" class="img-fluid rounded-circle shadow">
            <p class="mt-2 fw-semibold">Hamburguesas</p>
          </div>
        </div>
        <div class="col-md-2">
          <div class="categoria-card" role="button" data-categoria="pizzas" style="cursor:pointer">
            <img src="images/Pizza.jpeg" alt="Pizzas" class="img-fluid rounded-circle shadow">
            <p class="mt-2 fw-semibold">Pizzas</p>
          </div>
        </div>
        <div class="col-md-2">
          <div class="categoria-card" role="button" data-categoria="bebidas" style="cursor:pointer">
            <img src="images/bebidas.jpeg" alt="Bebidas" class="img-fluid rounded-circle shadow">
            <p class="mt-2 fw-semibold">Bebidas</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Secci√≥n donde se muestran los productos filtrados por categor√≠a -->
    <section id="productosSection" class="py-5" style="display:none;">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 id="productosTitle" class="titulo-antojo mb-0"></h2>
          <button id="volverCategoriasBtn" class="btn btn-outline-secondary">Volver</button>
        </div>
        <div id="productosGrid" class="row g-4"></div>
      </div>
    </section>

    <!-- Secci√≥n de Promociones -->
    <section class="seccion-promociones text-center py-5">
      <div class="container">
        <h2 class="titulo-antojo mb-4">üî• ¬°Promociones del D√≠a! üî•</h2>
        <p class="fs-5 fw-bold mb-5 text-dark">
          ¬°No dejes pasar estas ofertas irresistibles! Solo por tiempo limitado.
        </p>

        <div class="row justify-content-center g-4">
          <!-- Promo 1 -->
          <div class="col-md-4">
            <div class="card promo-card shadow-lg border-0 rounded-4">
              <div class="card-body text-center">
                <img src="images/promo1.png" alt="Promo Pizza" class="img-fluid rounded-4 mb-3"
                  style="height:200px; object-fit:cover;">
                <h5 class="fw-bold text-danger">2x1 en Pizzas Familiares üçï</h5>
                <p class="text-muted mb-3">Todos los martes y jueves. ¬°Para compartir!</p>
                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¬°P√≠dela Ya!</a>

                <!-- Bot√≥n para agregar al carrito -->
                <button class="btn btn-outline-danger mt-2 agregar-carrito" data-nombre="Pizza Familiar 2x1"
                  data-precio="29900">
                  Agregar al carrito
                </button>
              </div>
            </div>
          </div>

          <!-- Promo 2 -->
          <div class="col-md-4">
            <div class="card promo-card shadow-lg border-0 rounded-4">
              <div class="card-body text-center">
                <img src="images/promo2.webp" alt="Promo Burger" class="img-fluid rounded-4 mb-3"
                  style="height:200px; object-fit:cover;">
                <h5 class="fw-bold text-danger">Combo Burger + Bebida ü•§</h5>
                <p class="text-muted mb-3">Ll√©vate una burger premium + bebida por solo <b>$19.900</b>.
                </p>
                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¬°Quiero el combo!</a>

                <!-- Bot√≥n para agregar al carrito -->
                <button class="btn btn-outline-danger mt-2 agregar-carrito" data-nombre="Combo Burger + Bebida"
                  data-precio="19900">
                  Agregar al carrito
                </button>
              </div>
            </div>
          </div>


          <!-- Promo 3 -->
          <div class="col-md-4">
            <div class="card promo-card shadow-lg border-0 rounded-4">
              <div class="card-body text-center">
                <img src="images/promo3.jpg" alt="Promo Postre" class="img-fluid rounded-4 mb-3"
                  style="height:200px; object-fit:cover;">
                <h5 class="fw-bold text-danger">Postre GRATIS üç®</h5>
                <p class="text-muted mb-3">En compras superiores a $30.000. ¬°Dulce tentaci√≥n
                  garantizada!</p>
                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¬°End√∫lzate!</a>

                <!-- Bot√≥n para agregar al carrito -->
                <button class="btn btn-outline-danger mt-2 agregar-carrito" data-nombre="Postre GRATIS" data-precio="0">
                  Agregar al carrito
                </button>
              </div>
            </div>
          </div>
    </section>


    <!-- Nueva secci√≥n para "Te sugerimos" -->
    <section id="te-sugerimos" class="seccion-sugerencias">
      <h2 class="titulo-antojo">Te sugerimos</h2>
      <div class="row justify-content-center g-4">

        <!-- The Pizza Company -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/pizza_company.jpg" alt="The Pizza Company" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                The Pizza Company <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Cra+44+%23+37+-+10,+Tulu√°+Valle"
                  target="_blank" class="text-decoration-none text-dark">Caravans - Cra 44 # 37 - 10 / Tulu√°
                  Valle</a><br>
                <a href="https://www.instagram.com/thepizzacompanyco" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@thepizzacompanyco
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- Drive Pizza -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/Pizza_Drive.jpg" alt="Drive Pizza" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                Drive Pizza <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Calle+26+%23+35+-+41,+Alvernia"
                  target="_blank" class="text-decoration-none text-dark">Calle 26 # 35 - 41 B/ Alvernia</a><br>
                <a href="https://www.instagram.com/drivepizzatulua_" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@drivepizzatulua_
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- Oliva Pizza Garden -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/Pizza_Garden.jpg" alt="Oliva Pizza Garden" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                Oliva Pizza Garden <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Cra+40+%23+35,+Lomitas" target="_blank"
                  class="text-decoration-none text-dark">Cra 40 # 35 - Esquina B / Lomitas</a><br>
                <a href="https://www.instagram.com/olivapizzagarden" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@olivapizzagarden
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- ATA Burger -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/Ham_Ata.jpg" alt="ATA Burger" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                ATA <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Cra+26+%23+37+-+51,+Salesianos"
                  target="_blank" class="text-decoration-none text-dark">Cra 26 # 37 - 51 B / Salesianos</a><br>
                <a href="https://www.instagram.com/ataburgerexpress" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@ataburgerexpress
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- Smash Burger -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/Ham_Smash.jpg" alt="Smash Burger" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                Smash Burger <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Containers+Park,+Tulu√°" target="_blank"
                  class="text-decoration-none text-dark">Containers Park, Tulu√°</a><br>
                <a href="https://www.instagram.com/smashburger.tulua" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@smashburger.tulua
                </a>
              </p>
            </div>
          </div>
        </div>

        <!-- La Burger -->
        <div class="col-md-4">
          <div class="card h-100 shadow rounded-4">
            <div class="card-body text-center">
              <img src="images/Ham_Burger.jpg" alt="La Burger" class="img-fluid mb-2 rounded-4"
                style="max-height:200px; object-fit:cover;">
              <p class="fw-bold mb-0">
                La Burger <br>
                üìç<a href="https://www.google.com/maps/search/?api=1&query=Cra+26+%23+39+-+16,+El+Pr√≠ncipe,+Tulu√°"
                  target="_blank" class="text-decoration-none text-dark">Cra 26 # 39 - 16 B / El Pr√≠ncipe Tulu√°</a><br>
                <a href="https://www.instagram.com/laburger.col" target="_blank" class="text-decoration-none">
                  <i class="bi bi-instagram me-1" style="font-size:1.4rem; color:#E1306C;"></i>@laburger.col
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
      </div>
    </section>
  </main>
  <!-- Footer -->
  <footer class="bg-dark text-white pt-4 pb-0 mt-auto">
    <div class="container">
      <div class="row text-start">
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Enlaces r√°pidos</h5>
          <ul class="list-unstyled">
            <li>Explorar productos</li>
            <li>Tiendas cercanas</li>
            <li>Conocer m√°s</li>
          </ul>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Redes sociales</h5>
          <div class="d-flex gap-2">
            <img src="images/facebook.png" alt="Facebook" style="width:32px; height:32px;">
            <img src="images/tiktok.png" alt="TikTok" style="width:32px; height:32px;">
            <img src="images/twitter.png" alt="Twitter" style="width:32px; height:32px;">
            <img src="images/instagram.png" alt="Instagram" style="width:32px; height:32px;">
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Contacto</h5>
          <p class="mb-0">
            <a href="mailto:info@redelivery.com" class="text-white text-decoration-none">info@redelivery.com</a><br>
            <a href="tel:+573001234567" class="text-white text-decoration-none">üìû +57 300 123 4567</a>
          </p>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Informaci√≥n legal</h5>
          <ul class="list-unstyled">
            <li>T√©rminos y condiciones</li>
            <li>Pol√≠tica de privacidad</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Franja inferior: color distinto para que "derechos reservados" se vea -->
    <div class="footer-bottom mt-4 py-3 text-center" style="background-color:#e77b16; color:#111;">
      <p class="mb-0 small fw-semibold">¬©Ô∏è 2025 PedidosYEMM. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Guardar y verificar usuarios en localStorage
    document.addEventListener('DOMContentLoaded', function () {
      const loginForm = document.getElementById('loginForm');
      const toggleRegisterBtn = document.getElementById('toggleRegisterBtn');
      const registerFields = document.getElementById('registerFields');
      const loginBtn = document.getElementById('loginBtn');
      const loginMessage = document.getElementById('loginMessage');
      let isRegister = false;

      if (toggleRegisterBtn) {
        toggleRegisterBtn.addEventListener('click', function () {
          isRegister = !isRegister;
          registerFields.style.display = isRegister ? 'block' : 'none';
          loginBtn.textContent = isRegister ? 'Registrarse' : 'Iniciar sesi√≥n';
          toggleRegisterBtn.textContent = isRegister ? 'Ya tengo cuenta' : 'Registrarse';
          loginMessage.textContent = '';
        });
      }

      if (loginForm) {
        loginForm.addEventListener('submit', function (e) {
          e.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          const name = document.getElementById('registerName').value;
          const role = document.getElementById('userRole').value; // üëà capturamos el rol

          let users = JSON.parse(localStorage.getItem('users') || '{}');

          if (isRegister) {
            if (!name) {
              loginMessage.textContent = 'Por favor ingresa tu nombre.';
              loginMessage.style.color = 'red';
              return;
            }
            if (users[email]) {
              loginMessage.textContent = 'El usuario ya est√° registrado.';
              loginMessage.style.color = 'red';
            } else {
              // üëá guardamos tambi√©n el rol
              users[email] = { password, name, role };

              // Si es repartidor, asignamos un repartidorId
              if (role === "repartidor") {
                users[email].repartidorId = "r_" + email.split("@")[0];
              }

              localStorage.setItem('users', JSON.stringify(users));
              loginMessage.textContent = '¬°Registro exitoso! Ahora puedes iniciar sesi√≥n.';
              loginMessage.style.color = 'green';
              isRegister = false;
              registerFields.style.display = 'none';
              loginBtn.textContent = 'Iniciar sesi√≥n';
              toggleRegisterBtn.textContent = 'Registrarse';
            }
          } else {
            if (users[email] && users[email].password === password) {
              loginMessage.textContent = `¬°Bienvenido, ${users[email].name || 'usuario'}!`;
              loginMessage.style.color = 'green';

              // guardar sesi√≥n
              localStorage.setItem('loggedUser', email);

              // actualizar estado global/currentUser y texto del bot√≥n perfil inmediatamente
              currentUser = users[email];
              currentUser.email = email;
              const profileBtn = document.getElementById('profileBtn');
              if (profileBtn) profileBtn.innerHTML = `<i class="bi bi-person"></i> ${users[email].name || 'Mi Perfil'}`;

              setTimeout(() => {
                bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).hide();
                // eliminar backdrops sobrantes por seguridad y quitar clase modal-open
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.classList.remove('modal-open');

                // üëá control de acceso por rol
                const repartidorBtn = document.getElementById('btnRepartidor');
                const reportesBtn = document.getElementById('btnReportes');
                if (users[email].role === "repartidor" && repartidorBtn) {
                  repartidorBtn.style.display = "inline-block";
                  const modal = new bootstrap.Modal(document.getElementById('repartidorModal'));
                  modal.show();
                } else if (repartidorBtn) {
                  repartidorBtn.style.display = "none";
                }
                if (users[email].role === "admin" && reportesBtn) {
                  reportesBtn.style.display = "inline-block";
                } else if (reportesBtn) {
                  reportesBtn.style.display = "none";
                }
              }, 1000);
            } else {
              loginMessage.textContent = 'Correo o contrase√±a incorrectos.';
              loginMessage.style.color = 'red';
            }
          }
        });
      }


      // Actualizar texto del bot√≥n de perfil si hay sesi√≥n activa
      const logged = localStorage.getItem('loggedUser');
      if (logged) {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[logged];
        if (user) {
          const btn = document.getElementById('profileBtn');
          if (btn) btn.innerHTML = `<i class="bi bi-person"></i> ${user.name || 'Mi Perfil'}`;
        }
      }
    });

    let currentUser = null;

    function showProfileModal(user) {
      // limpiar cualquier historial de pedidos previamente a√±adido para evitar duplicados
      const modalBody = document.getElementById('profileModal').querySelector('.modal-body');
      const existingPedidos = modalBody.querySelector('.profile-pedidos-container');
      if (existingPedidos) existingPedidos.remove();

      document.getElementById('profileName').textContent = user.name || '';
      document.getElementById('profileEmail').textContent = user.email || '';

      // Foto
      const photo = user.photo || 'https://via.placeholder.com/90x90?text=Foto';
      document.getElementById('profilePhoto').src = photo;

      // Direcciones
      const addresses = user.addresses || [];
      const ul = document.getElementById('profileAddresses');
      ul.innerHTML = '';
      if (addresses.length === 0) {
        ul.innerHTML = '<li class="list-group-item">No hay direcciones registradas.</li>';
      } else {
        addresses.forEach(addr => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = addr;
          ul.appendChild(li);
        });
      }

      // üßæ Historial de pedidos
      const pedidosPorUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario')) || {};
      const pedidos = pedidosPorUsuario[user.email] || [];

      const pedidosContainer = document.createElement('div');
      pedidosContainer.className = 'mt-4 profile-pedidos-container';
      pedidosContainer.innerHTML = '<h6>üßæ Historial de pedidos</h6>';

      if (pedidos.length === 0) {
        pedidosContainer.innerHTML += '<p class="text-muted">No hay pedidos registrados.</p>';
      } else {
        const ulPedidos = document.createElement('ul');
        ulPedidos.className = 'list-group';
        pedidos.forEach(p => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `
        <strong>${p.fecha}</strong><br>
        Productos: ${p.productos.map(prod => prod.nombre).join(', ')}<br>
        Total: $${p.total.toLocaleString()}<br>
        Direcci√≥n: ${p.direccion}
      `;
          ulPedidos.appendChild(li);
        });
        pedidosContainer.appendChild(ulPedidos);
      }

      modalBody.appendChild(pedidosContainer);

      // ‚ûï Mostrar rol y responsabilidades
      const roleInfo = document.createElement('div');
      roleInfo.className = "mt-3";

      if (user.role === "repartidor") {
        roleInfo.innerHTML = `
      <h6>Rol: Repartidor üöö</h6>
      <p class="text-muted mb-1">ID de repartidor: ${user.repartidorId || 'No asignado'}</p>
      <p class="text-muted mb-1">Responsabilidades: aceptar pedidos, actualizar estado y confirmar entregas.</p>
    `;
      } else if (user.role === "admin") {
        roleInfo.innerHTML = `
      <h6>Rol: S√∫per Administrador üõ†Ô∏è</h6>
      <p class="text-muted mb-1">Gesti√≥n integral de repartidores, tiendas, categor√≠as y reportes.</p>
    `;
      } else {
        roleInfo.innerHTML = `
      <h6>Rol: Cliente üõí</h6>
      <p class="text-muted mb-1">Puede registrar datos y realizar pedidos.</p>
    `;
      }

      modalBody.appendChild(roleInfo);

      // Mostrar modal
      bootstrap.Modal.getOrCreateInstance(document.getElementById('profileModal')).show();
    }

    document.getElementById("profileBtn").addEventListener("click", function () {
      if (currentUser) {
        showProfileModal(currentUser);
      }
    });

    // Guardar foto de perfil
    const photoInputEl = document.getElementById('photoInput');
    if (photoInputEl) {
      photoInputEl.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          document.getElementById('profilePhoto').src = evt.target.result;
          // Guardar en localStorage
          let users = JSON.parse(localStorage.getItem('users') || '{}');
          if (currentUser && users[currentUser.email]) {
            users[currentUser.email].photo = evt.target.result;
            localStorage.setItem('users', JSON.stringify(users));
          }
        };
        reader.readAsDataURL(file);
      });
    }

    // Bot√≥n perfil: muestra login o perfil seg√∫n sesi√≥n
    const profileBtnEl = document.getElementById('profileBtn');
    if (profileBtnEl) {
      profileBtnEl.addEventListener('click', function (e) {
        e.preventDefault();
        const logged = localStorage.getItem('loggedUser');
        if (logged) {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          const user = users[logged];
          if (user) {
            user.email = logged;
            currentUser = user;
            showProfileModal(user);
            return;
          }
        }
        // Si no est√° logueado, muestra login (usar getOrCreateInstance)
        bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).show();
      });
    }

    // Cerrar sesi√≥n
    const logoutBtnEl = document.getElementById('logoutBtn');
    if (logoutBtnEl) {
      logoutBtnEl.addEventListener('click', function () {
        localStorage.removeItem('loggedUser');

        // reset UI y estado local para permitir nuevo inicio de sesi√≥n
        currentUser = null;
        const profileBtn = document.getElementById('profileBtn');
        if (profileBtn) profileBtn.innerHTML = `<i class="bi bi-person"></i> Mi Perfil`;

        // limpiar modal de perfil para que no muestre datos viejos
        const profileNameEl = document.getElementById('profileName');
        const profileEmailEl = document.getElementById('profileEmail');
        if (profileNameEl) profileNameEl.textContent = '';
        if (profileEmailEl) profileEmailEl.textContent = '';
        const profilePhotoEl = document.getElementById('profilePhoto');
        if (profilePhotoEl) profilePhotoEl.src = 'https://via.placeholder.com/90x90?text=Foto';
        const profileAddressesEl = document.getElementById('profileAddresses');
        if (profileAddressesEl) profileAddressesEl.innerHTML = '';

        bootstrap.Modal.getOrCreateInstance(document.getElementById('profileModal')).hide();
        // limpieza por si queda backdrop
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });
    }

  </script>

  <!-- Modal Carrito -->
  <div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="carritoModalLabel">üõí Tu Carrito</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <ul id="carritoLista" class="list-group mb-3"></ul>
          <h5 class="text-end">Total: <span id="carritoTotal">$0</span></h5>

          <div class="d-grid gap-2">
            <button class="btn btn-danger" id="confirmarPedidoBtn">Confirmar Pedido</button>
            <!-- Bot√≥n para confirmar sin pago (efectivo / contra entrega) -->
            <button class="btn btn-outline-dark" id="confirmarSinPagoBtn">Confirmar sin pagar (Efectivo)</button>
            <!-- Contenedor para el bot√≥n de PayPal -->
            <div id="paypal-button-container" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>




  <!-- TOAST: notificaci√≥n cuando falta direcci√≥n -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <div id="toastNoDireccion" class="toast align-items-center text-bg-warning border-0" role="alert"
      aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          Debes ingresar una direcci√≥n antes de confirmar el pedido.
        </div>
        <button type="button" class="btn btn-sm btn-outline-dark me-2 mt-1" id="abrirDireccionFromToast">Ingresar
          direcci√≥n</button>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <script>
    // CARRITO
    let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
    // mantener referencia global por compatibilidad con partes del c√≥digo que usan window.carrito
    window.carrito = carrito;

    function actualizarCarrito() {
      const lista = document.getElementById('carritoLista');
      const total = document.getElementById('carritoTotal');
      if (!lista || !total) return;
      lista.innerHTML = '';
      let suma = 0;

      carrito.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
        ${item.nombre} - $${item.precio}
        <button class="btn btn-sm btn-outline-danger" onclick="eliminarDelCarrito(${index})">Eliminar</button>
      `;
        lista.appendChild(li);
        suma += Number(item.precio) || 0;
      });

      total.textContent = `$${suma.toLocaleString()}`;
      localStorage.setItem('carrito', JSON.stringify(carrito));
      // sincronizar window.carrito
      window.carrito = carrito;
    }

    function eliminarDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    }

    document.querySelectorAll('.agregar-carrito').forEach(btn => {
      btn.addEventListener('click', function () {
        const nombre = this.dataset.nombre;
        const precio = parseInt(this.dataset.precio) || 0;
        carrito.push({ nombre, precio });
        actualizarCarrito();
      });
    });

    // Init carrito view on load
    actualizarCarrito();
  </script>

  <!-- PayPal SDK: UNA sola inclusi√≥n (tu client-id) -->
  <script
    src="https://www.paypal.com/sdk/js?client-id=AezkTw_Rnc_YxwEh_mTwsJofzRnmPQab0Bwmh6_ZJ-BfidkEul1814c5J1i0ONcVZIZ0Tdmmr4YbelgF&currency=USD"></script>

  <script>
    // Control de renderizado
    window.__paypalButtonsReady = false;
    window.__paypalButtonElement = null;

    // Espera a que window.paypal est√© disponible (timeout)
    function waitForPaypalSdk(timeoutMs = 5000) {
      return new Promise((resolve, reject) => {
        if (window.paypal) return resolve();
        const start = Date.now();
        const iv = setInterval(() => {
          if (window.paypal) {
            clearInterval(iv);
            return resolve();
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            return reject(new Error('PayPal SDK no carg√≥ en el tiempo esperado'));
          }
        }, 100);
      });
    }

    function initPayPalButtons() {
      if (window.__paypalButtonsReady) return Promise.resolve();

      return waitForPaypalSdk(7000)
        .then(() => {
          const container = document.getElementById('paypal-button-container');
          if (!container) {
            throw new Error('No existe #paypal-button-container');
          }
          // limpiar antes de renderizar
          container.innerHTML = '';

          return paypal.Buttons({
            style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'pay' },

            createOrder: function (data, actions) {
              try {
                const carritoLocal = JSON.parse(localStorage.getItem('carrito') || '[]');

                if (!carritoLocal.length) {
                  alert('Tu carrito est√° vac√≠o.');
                  return Promise.reject(new Error('Carrito vac√≠o'));
                }

                // verificar direcci√≥n: preferir localStorage, si no tomar la primera del perfil en users
                let direccionSeleccionada = localStorage.getItem('direccion') || '';
                if (!direccionSeleccionada) {
                  const logged = localStorage.getItem('loggedUser');
                  if (logged) {
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    const user = users[logged];
                    if (user && Array.isArray(user.addresses) && user.addresses.length > 0) {
                      direccionSeleccionada = user.addresses[0];
                      // opcional: establecerla en localStorage para futuros usos
                      localStorage.setItem('direccion', direccionSeleccionada);
                    }
                  }
                }

                if (!direccionSeleccionada || direccionSeleccionada.trim() === "") {
                  alert('Debes ingresar una direcci√≥n para confirmar el pedido.');
                  return Promise.reject(new Error('Direcci√≥n no registrada'));
                }

                const total = carritoLocal.reduce((s, i) => s + (Number(i.precio) || 0), 0);
                // PayPal espera valor en moneda configurada; aqu√≠ se usa USD (ajusta si necesario)
                const amountValue = total.toFixed(2);
                return actions.order.create({
                  purchase_units: [{
                    amount: { value: amountValue, currency_code: 'USD' },
                    description: 'Pedido PEDIDOS YEMM'
                  }]
                });
              } catch (err) {
                console.error('Error en createOrder:', err);
                return Promise.reject(err);
              }
            },

            onApprove: function (data, actions) {
              return actions.order.capture().then(function (details) {
                try {
                  const carritoLocal = JSON.parse(localStorage.getItem('carrito') || '[]');
                  const email = localStorage.getItem('loggedUser') || 'invitado';
                  const direccion = localStorage.getItem('direccion') || 'Sin direcci√≥n registrada';
                  const total = carritoLocal.reduce((s, i) => s + (Number(i.precio) || 0), 0);
                  const fecha = new Date().toLocaleString();

                  const pedido = {
                    productos: carritoLocal,
                    total,
                    fecha,
                    direccion,
                    pago: 'paypal',
                    paypalOrderId: data.orderID,
                    comprador: details.payer || null
                  };

                  let pedidosPorUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario') || '{}');
                  if (!pedidosPorUsuario[email]) pedidosPorUsuario[email] = [];
                  pedidosPorUsuario[email].push(pedido);
                  localStorage.setItem('pedidosPorUsuario', JSON.stringify(pedidosPorUsuario));

                  let pedidosGlobales = JSON.parse(localStorage.getItem('pedidosGlobales') || '[]');
                  pedidosGlobales.push({ cliente: email, productos: carritoLocal, total, fecha, direccion, estado: 'pagado', metodo: 'paypal', paypalOrderId: data.orderID });
                  localStorage.setItem('pedidosGlobales', JSON.stringify(pedidosGlobales));

                  // limpiar carrito correctamente (variable + localStorage + UI)
                  carrito = [];
                  localStorage.setItem('carrito', JSON.stringify([]));
                  if (typeof actualizarCarrito === 'function') actualizarCarrito();

                  alert('Pago completado. Gracias ' + ((details.payer && details.payer.name && details.payer.name.given_name) ? details.payer.name.given_name : '') + '!');
                  bootstrap.Modal.getOrCreateInstance(document.getElementById('carritoModal')).hide();
                  // quitar posibles backdrops y limpiar container PayPal
                  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                  const container = document.getElementById('paypal-button-container');
                  if (container) container.innerHTML = '';
                  window.__paypalButtonsReady = false;
                  window.__paypalButtonElement = null;
                  document.body.classList.remove('modal-open');
                } catch (err) {
                  console.error('Error guardando pedido en onApprove:', err);
                  alert('Ocurri√≥ un error al procesar el pedido. Revisa la consola.');
                }
              }).catch(err => {
                console.error('Error en capture():', err);
                alert('Error al capturar el pago. Revisa la consola.');
              });
            },

            onError: function (err) {
              console.error('PayPal onError:', err);
              alert('Error en el proceso de pago. Intenta de nuevo.');
            }
          }).render('#paypal-button-container').then(() => {
            window.__paypalButtonsReady = true;
            const container = document.getElementById('paypal-button-container');
            window.__paypalButtonElement = container && container.querySelector('button');
            console.info('PayPal Buttons renderizados y listos.');
          });
        })
    }


    // Poll para buscar el bot√≥n interno de PayPal (intento de auto-click)
    function clickPaypalInternalButton(timeoutMs = 5000, intervalMs = 300) {
      return new Promise(resolve => {
        const start = Date.now();
        const iv = setInterval(() => {
          const container = document.getElementById('paypal-button-container');
          const btn = container && container.querySelector('button');
          if (btn) {
            clearInterval(iv);
            try { btn.click(); } catch (err) { console.warn('No se pudo clickear bot√≥n interno:', err); }
            return resolve(true);
          }
          if (Date.now() - start > timeoutMs) {
            clearInterval(iv);
            return resolve(false);
          }
        }, intervalMs);
      });
    }

    // Manejo cruzado de modales para evitar superposici√≥n / PayPal quedando detr√°s
    (function setupModalInteraction() {
      const carritoModalEl = document.getElementById('carritoModal');
      const direccionModalEl = document.getElementById('direccionModal');
      const paypalContainer = document.getElementById('paypal-button-container');

      // Cuando se muestra carrito, ocultar direcci√≥n y limpiar posibles backdrops
      if (carritoModalEl) {
        carritoModalEl.addEventListener('show.bs.modal', function () {
          if (direccionModalEl) {
            const instDir = bootstrap.Modal.getOrCreateInstance(direccionModalEl);
            try { instDir.hide(); } catch (e) { /* ignore */ }
          }
          // limpiar backdrops anteriores
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          document.body.classList.remove('modal-open');
        });

        carritoModalEl.addEventListener('shown.bs.modal', function () {
          // inicializar PayPal
          initPayPalButtons().catch(() => { /* ya notifica al usuario en init */ });
        });

        carritoModalEl.addEventListener('hisdden.bs.modal', function () {
          // limpiar container PayPal y backdrops al cerrar carrito
          if (paypalContainer) paypalContainer.innerHTML = '';
          window.__paypalButtonsReady = false;
          window.__paypalButtonElement = null;
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          document.body.classList.remove('modal-open');
        });
      }

      // Cuando se muestra direccion, ocultar carrito y limpiar PayPal
      if (direccionModalEl) {
        direccionModalEl.addEventListener('show.bs.modal', function () {
          if (carritoModalEl) {
            const instCar = bootstrap.Modal.getOrCreateInstance(carritoModalEl);
            try { instCar.hide(); } catch (e) { /* ignore */ }
          }
          if (paypalContainer) paypalContainer.innerHTML = '';
          window.__paypalButtonsReady = false;
          window.__paypalButtonElement = null;
          // limpiar backdrops
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          document.body.classList.remove('modal-open');
        });

        direccionModalEl.addEventListener('hidden.bs.modal', function () {
          // limpieza adicional al cerrar direcci√≥n
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          document.body.classList.remove('modal-open');
        });
      }

      // Abrir modal direcci√≥n desde toast: asegurarse que carrito est√© cerrado
      const abrirBtn = document.getElementById('abrirDireccionFromToast');
      if (abrirBtn) {
        abrirBtn.addEventListener('click', function () {
          if (carritoModalEl) {
            const instCar = bootstrap.Modal.getOrCreateInstance(carritoModalEl);
            try { instCar.hide(); } catch (e) { /* ignore */ }
          }
          bootstrap.Modal.getOrCreateInstance(direccionModalEl).show();
          const t = bootstrap.Toast.getInstance(document.getElementById('toastNoDireccion'));
          if (t) t.hide();
        });
      }
    })();

    // Handler para guardar/editar/eliminar direcci√≥n desde el modal
    (function handleDireccionForm() {
      const direccionForm = document.getElementById('direccionForm') || document.querySelector('#direccionModal form');
      if (!direccionForm) return;

      const direccionModalEl = document.getElementById('direccionModal');
      const guardarBtn = document.getElementById('guardarDireccionBtn');
      const eliminarBtn = document.getElementById('eliminarDireccionBtn');

      // Actualiza la lista de direcciones en el modal de perfil si est√° abierto
      function refreshProfileAddressesUI() {
        const logged = localStorage.getItem('loggedUser');
        if (!logged) return;
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        const user = users[logged];
        if (!user) return;
        const ul = document.getElementById('profileAddresses');
        if (!ul) return;
        ul.innerHTML = '';
        const addresses = user.addresses || [];
        if (addresses.length === 0) {
          ul.innerHTML = '<li class="list-group-item">No hay direcciones registradas.</li>';
        } else {
          addresses.forEach(addr => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = addr;
            ul.appendChild(li);
          });
        }
      }

      // Rellenar formulario si ya existe direcci√≥n guardada
      function prefillDireccion() {
        const obj = JSON.parse(localStorage.getItem('direccionObj') || 'null');
        const texto = localStorage.getItem('direccion') || '';
        if (obj) {
          document.getElementById('calle').value = obj.calle || '';
          document.getElementById('ciudad').value = obj.ciudad || '';
          document.getElementById('departamento').value = obj.departamento || '';
          document.getElementById('codigoPostal').value = obj.codigoPostal || '';
          if (guardarBtn) guardarBtn.textContent = 'Actualizar Direcci√≥n';
          if (eliminarBtn) eliminarBtn.style.display = 'inline-block';
        } else if (texto) {
          // si s√≥lo hay texto, mostrarlo en calle para edici√≥n r√°pida
          document.getElementById('calle').value = texto;
          document.getElementById('ciudad').value = '';
          document.getElementById('departamento').value = '';
          document.getElementById('codigoPostal').value = '';
          if (guardarBtn) guardarBtn.textContent = 'Actualizar Direcci√≥n';
          if (eliminarBtn) eliminarBtn.style.display = 'inline-block';
        } else {
          // no hay direcci√≥n registrada -> limpiar formulario
          document.getElementById('calle').value = '';
          document.getElementById('ciudad').value = '';
          document.getElementById('departamento').value = '';
          document.getElementById('codigoPostal').value = '';
          if (guardarBtn) guardarBtn.textContent = 'Guardar Direcci√≥n';
          if (eliminarBtn) eliminarBtn.style.display = 'none';
        }
      }

      // Al abrir el modal, rellenar si corresponde
      if (direccionModalEl) {
        direccionModalEl.addEventListener('show.bs.modal', function () {
          prefillDireccion();
        });
      }

      direccionForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const calle = document.getElementById('calle').value.trim();
        const ciudad = document.getElementById('ciudad').value.trim();
        const departamento = document.getElementById('departamento').value.trim();
        const codigoPostal = document.getElementById('codigoPostal').value.trim();

        if (!calle || !ciudad) {
          alert('Por favor completa calle y ciudad.');
          return;
        }

        const direccionTexto = `${calle}, ${ciudad}${departamento ? ', ' + departamento : ''}${codigoPostal ? ' - CP ' + codigoPostal : ''}`;
        const direccionObj = { calle, ciudad, departamento, codigoPostal };

        // Guardar tanto texto como objeto estructurado
        localStorage.setItem('direccion', direccionTexto);
        localStorage.setItem('direccionObj', JSON.stringify(direccionObj));

        // si hay usuario logueado, guardarla en su perfil (array addresses) evitando duplicados
        const logged = localStorage.getItem('loggedUser');
        if (logged) {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          if (!users[logged]) users[logged] = {};
          users[logged].addresses = users[logged].addresses || [];
          // evitar duplicados exactos
          if (!users[logged].addresses.includes(direccionTexto)) {
            users[logged].addresses.push(direccionTexto);
          }
          localStorage.setItem('users', JSON.stringify(users));
        }

        // cerrar modal y limpiar backdrop si qued√≥
        bootstrap.Modal.getOrCreateInstance(document.getElementById('direccionModal')).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');

        // actualizar UI del perfil si corresponde
        refreshProfileAddressesUI();

        alert('Direcci√≥n guardada.');
      });

      // Eliminar direcci√≥n registrada
      if (eliminarBtn) {
        eliminarBtn.addEventListener('click', function () {
          const confirmDel = confirm('¬øDeseas eliminar la direcci√≥n registrada?');
          if (!confirmDel) return;

          const direccionTexto = localStorage.getItem('direccion') || '';
          localStorage.removeItem('direccion');
          localStorage.removeItem('direccionObj');

          // si hay usuario logueado, eliminar la direcci√≥n del perfil (si coincide)
          const logged = localStorage.getItem('loggedUser');
          if (logged) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[logged] && Array.isArray(users[logged].addresses)) {
              users[logged].addresses = users[logged].addresses.filter(a => a !== direccionTexto);
              localStorage.setItem('users', JSON.stringify(users));
            }
          }

          // limpiar formulario y ocultar bot√≥n eliminar
          document.getElementById('calle').value = '';
          document.getElementById('ciudad').value = '';
          document.getElementById('departamento').value = '';
          document.getElementById('codigoPostal').value = '';
          if (guardarBtn) guardarBtn.textContent = 'Guardar Direcci√≥n';
          eliminarBtn.style.display = 'none';

          // actualizar UI del perfil si corresponde
          refreshProfileAddressesUI();

          alert('Direcci√≥n eliminada.');
        });
      }
    })();

    // ...existing code...
    (function attachConfirm() {
      const confirmarEl = document.getElementById('confirmarPedidoBtn');
      if (!confirmarEl) return;
      // remove previous listeners safely
      const nuevo = confirmarEl.cloneNode(true);
      confirmarEl.parentNode.replaceChild(nuevo, confirmarEl);

      nuevo.addEventListener('click', async function (e) {
        e.preventDefault();

        // sincronizar desde localStorage para evitar desincron√≠as
        try {
          carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
          window.carrito = carrito;
        } catch (err) {
          carrito = [];
          window.carrito = carrito;
        }

        if (!Array.isArray(carrito) || carrito.length === 0) {
          alert('Tu carrito est√° vac√≠o.');
          return;
        }

        // VALIDACI√ìN: verificar si existe direcci√≥n (localStorage o en perfil del usuario)
        const direccionLocal = localStorage.getItem('direccion');
        let tieneDireccion = Boolean(direccionLocal && direccionLocal.trim());

        if (!tieneDireccion) {
          const logged = localStorage.getItem('loggedUser');
          if (logged) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[logged];
            if (user && Array.isArray(user.addresses) && user.addresses.length > 0) {
              tieneDireccion = true;
              // opcional: establecer la primera como direcci√≥n activa
              localStorage.setItem('direccion', user.addresses[0]);
            }
          }
        }

        if (!tieneDireccion) {
          // mostrar toast de aviso y no continuar con el flujo de pago
          const toastEl = document.getElementById('toastNoDireccion');
          if (toastEl) new bootstrap.Toast(toastEl, { delay: 6000 }).show();
          return;
        }

        // abrir modal carrito (se encargar√° de inicializar PayPal y ocultar direcci√≥n)
        bootstrap.Modal.getOrCreateInstance(document.getElementById('carritoModal')).show();

        // asegurarse de que PayPal Buttons se inicialicen
        try {
          await initPayPalButtons();
          // espera y trata de clickear el bot√≥n interno (si existe)
          const clicked = await clickPaypalInternalButton(5000, 300);
          if (!clicked) {
            // no forzar, pedir al usuario que pulse
            console.info('No se encontr√≥ el bot√≥n interno de PayPal para auto-click; solicita al usuario pulsar el bot√≥n.');
          }
        } catch (err) {
          console.warn('No fue posible inicializar PayPal para auto-click:', err);
        }
      });
    })();

    // ...inserted: handler para "Confirmar sin pagar (Efectivo)"...
    (function handleConfirmarSinPago() {
      const btn = document.getElementById('confirmarSinPagoBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        // sincronizar carrito
        try { carrito = JSON.parse(localStorage.getItem('carrito') || '[]'); window.carrito = carrito; } catch (e) { carrito = []; window.carrito = carrito; }
        if (!Array.isArray(carrito) || carrito.length === 0) { alert('Tu carrito est√° vac√≠o.'); return; }

        // verificar direcci√≥n
        let direccion = localStorage.getItem('direccion') || '';
        if (!direccion) {
          const logged = localStorage.getItem('loggedUser');
          if (logged) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[logged];
            if (user && Array.isArray(user.addresses) && user.addresses.length > 0) {
              direccion = user.addresses[0];
              localStorage.setItem('direccion', direccion);
            }
          }
        }
        if (!direccion || !direccion.trim()) { const t = document.getElementById('toastNoDireccion'); if (t) new bootstrap.Toast(t, { delay: 6000 }).show(); return; }

        // crear pedido local
        const total = carrito.reduce((s, i) => s + (Number(i.precio) || 0), 0);
const tiendaSeleccionada = carrito.find(p => p.tienda)?.tienda || "sin_tienda";

        const pedido = {
          id: 'local_' + Date.now(),
          productos: carrito,
          total,
          fecha: new Date().toLocaleString(),
          direccion,
          estado: 'pendiente',
          metodo: 'efectivo',
          cliente: localStorage.getItem('loggedUser') || 'invitado',
          repartidorId: null,
          tienda: tiendaSeleccionada
        };


        // guardar pedidos por usuario
        const email = pedido.cliente;
        const pedidosPorUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario') || '{}');
        pedidosPorUsuario[email] = pedidosPorUsuario[email] || [];
        pedidosPorUsuario[email].push(pedido);
        localStorage.setItem('pedidosPorUsuario', JSON.stringify(pedidosPorUsuario));

        // guardar globales
        const pedidosGlobales = JSON.parse(localStorage.getItem('pedidosGlobales') || '[]');
        pedidosGlobales.push(pedido);
        localStorage.setItem('pedidosGlobales', JSON.stringify(pedidosGlobales));

        // limpiar carrito y UI
        carrito = [];
        localStorage.setItem('carrito', JSON.stringify([]));
        if (typeof actualizarCarrito === 'function') actualizarCarrito();

        alert('Pedido confirmado. Pagar√°s en efectivo al recibirlo.');
        bootstrap.Modal.getOrCreateInstance(document.getElementById('carritoModal')).hide();
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });
    })();
    document.addEventListener('DOMContentLoaded', function () {
      // Cat√°logo de ejemplo con tiendas asignadas
      const productosCatalogo = {
        hamburguesas: [
          { id: 'h1', nombre: 'Classic Burger', precio: 15900, img: 'images/Hamburguesa.jpg', descripcion: 'Carne, lechuga, tomate y salsa especial.', tienda: 'La Burger' },
          { id: 'h2', nombre: 'Bacon Burger', precio: 17900, img: 'images/Ham_Ata.jpg', descripcion: 'Con bacon crocante y queso.', tienda: 'ATA Burger' },
          { id: 'h3', nombre: 'Cheese Burger', precio: 16900, img: 'images/Ham_Smash.jpg', descripcion: 'Doble queso fundido.', tienda: 'Smash Burger' },
          { id: 'h4', nombre: 'Chicken Burger', precio: 27000, img: 'images/Ham_Chicken.png', descripcion: 'Pollo empanado, lechuga y mayonesa.', tienda: 'La Burger' },
          { id: 'h5', nombre: 'Veggie Burger', precio: 13900, img: 'images/Ham_Veggie.png', descripcion: 'Hamburguesa vegetal con aguacate.', tienda: 'La Burger' },
          { id: 'h6', nombre: 'Double Meat', precio: 19900, img: 'images/Ham_Double.png', descripcion: 'Doble carne, doble queso.', tienda: 'ATA Burger' },
          { id: 'h7', nombre: 'Spicy Burger', precio: 16900, img: 'images/Ham_Spicy.png', descripcion: 'Salsa picante y jalape√±os.', tienda: 'Smash Burger' },
          { id: 'h8', nombre: 'Mushroom Burger', precio: 16900, img: 'images/Ham_Mushroom.png', descripcion: 'Champi√±ones salteados y queso suizo.', tienda: 'Oliva Pizza Garden' },
          { id: 'h9', nombre: 'Blue Cheese', precio: 17900, img: 'images/Ham_Blue.png', descripcion: 'Queso azul y cebolla caramelizada.', tienda: 'La Burger' },
          { id: 'h10', nombre: 'BBQ Deluxe', precio: 18900, img: 'images/Ham_BBQ.png', descripcion: 'Salsa BBQ, onion rings y bacon.', tienda: 'Drive Pizza' },
          { id: 'h11', nombre: 'Guacamole Burger', precio: 17900, img: 'images/Ham_Guac.png', descripcion: 'Carne jugosa con guacamole fresco y totopos crujientes.', tienda: 'ATA Burger' },
          { id: 'h12', nombre: 'Tex-Mex Burger', precio: 18900, img: 'images/Ham_Tex.png', descripcion: 'Salsa mexicana, jalape√±os y queso cheddar fundido.', tienda: 'Smash Burger' },
          { id: 'h13', nombre: 'Hawaiian Burger', precio: 16900, img: 'images/Ham_Hawaii.png', descripcion: 'Pi√±a asada, jam√≥n y salsa teriyaki.', tienda: 'Oliva Pizza Garden' },
          { id: 'h14', nombre: 'Truffle Burger', precio: 21900, img: 'images/Ham_Trufa.png', descripcion: 'Queso gouda y mayonesa de trufa negra.', tienda: 'La Burger' },
          { id: 'h15', nombre: 'Egg & Cheese Burger', precio: 17900, img: 'images/Ham_Egg.png', descripcion: 'Huevo frito, queso cheddar y tocino.', tienda: 'Smash Burger' },
          { id: 'h16', nombre: 'Mediterranean Burger', precio: 18900, img: 'images/Ham_Med.png', descripcion: 'Queso feta, aceitunas negras y salsa tzatziki.', tienda: 'Oliva Pizza Garden' },
          { id: 'h17', nombre: 'Smoky Burger', precio: 19900, img: 'images/Ham_Smoke.png', descripcion: 'Sabor ahumado con salsa BBQ artesanal.', tienda: 'Drive Pizza' },
          { id: 'h18', nombre: 'Crispy Onion Burger', precio: 17900, img: 'images/Ham_Onion.png', descripcion: 'Crujientes aros de cebolla y queso americano.', tienda: 'La Burger' },
          { id: 'h19', nombre: 'Buffalo Chicken Burger', precio: 16900, img: 'images/Ham_Buffalo.png', descripcion: 'Pollo en salsa buffalo con aderezo ranch.', tienda: 'ATA Burger' },
          { id: 'h20', nombre: 'Italian Burger', precio: 18900, img: 'images/Ham_Italian.png', descripcion: 'Queso mozzarella, tomate seco y pesto de albahaca.', tienda: 'Oliva Pizza Garden' }
        ],
        pizzas: [
          { id: 'p1', nombre: 'Margarita', precio: 24900, img: 'images/Pizza.jpeg', descripcion: 'Salsa de tomate, mozzarella y albahaca.', tienda: 'Oliva Pizza Garden' },
          { id: 'p2', nombre: 'Pepperoni', precio: 26900, img: 'images/promo1.png', descripcion: 'Extra pepperoni y queso.', tienda: 'Drive Pizza' },
          { id: 'p3', nombre: 'Hawaiana', precio: 25900, img: 'images/Pizza_Hawai.png', descripcion: 'Jam√≥n y pi√±a.', tienda: 'The Pizza Company' },
          { id: 'p4', nombre: 'Cuatro Quesos', precio: 27900, img: 'images/Pizza_Drive.jpg', descripcion: 'Mozzarella, gorgonzola, parmesano y cheddar.', tienda: 'Drive Pizza' },
          { id: 'p5', nombre: 'BBQ Chicken', precio: 28900, img: 'images/Pizza_BBQ.png', descripcion: 'Pollo, salsa BBQ y cilantro.', tienda: 'La Burger' },
          { id: 'p6', nombre: 'Vegetariana', precio: 23900, img: 'images/Pizza.jpeg', descripcion: 'Pimientos, champi√±ones y aceitunas.', tienda: 'Oliva Pizza Garden' },
          { id: 'p7', nombre: 'Mexicana', precio: 26900, img: 'images/Pizza_Mexicana.png', descripcion: 'Carne, jalape√±os y salsa picante.', tienda: 'ATA Burger' },
          { id: 'p8', nombre: 'Prosciutto', precio: 29900, img: 'images/Pizza_Pro.png', descripcion: 'Jam√≥n serrano y r√∫cula.', tienda: 'Oliva Pizza Garden' },
          { id: 'p9', nombre: 'Marinera', precio: 29900, img: 'images/Pizza_Toscana.png', descripcion: 'Mariscos y ajo.', tienda: 'Drive Pizza' },
          { id: 'p10', nombre: 'Especial de la Casa', precio: 31900, img: 'images/Pizza_Garden.jpg', descripcion: 'Ingredientes premium y salsa secreta.', tienda: 'Oliva Pizza Garden' },
          { id: 'p11', nombre: 'Carbonara', precio: 28900, img: 'images/Pizza_Carbonara.png', descripcion: 'Salsa blanca, panceta, huevo y queso parmesano.', tienda: 'The Pizza Company' },
          { id: 'p12', nombre: 'Trufada', precio: 32900, img: 'images/Pizza_Trufa.png', descripcion: 'Crema de trufa, champi√±ones y queso gouda.', tienda: 'La Burger' },
          { id: 'p13', nombre: 'Mediterr√°nea', precio: 27900, img: 'images/Pizza_Mediterranea.png', descripcion: 'Aceitunas negras, tomate seco y queso feta.', tienda: 'Oliva Pizza Garden' },
          { id: 'p14', nombre: 'Pollo y Champi√±ones', precio: 26900, img: 'images/Pizza_Pollo.png', descripcion: 'Pollo asado, champi√±ones y crema de ajo.', tienda: 'Drive Pizza' },
          { id: 'p15', nombre: 'Napolitana', precio: 25900, img: 'images/Pizza_Napolitana.png', descripcion: 'Salsa de tomate natural, mozzarella y or√©gano.', tienda: 'The Pizza Company' },
          { id: 'p16', nombre: 'Toscana', precio: 29900, img: 'images/Pizza_Toscana.png', descripcion: 'Salchicha italiana, pimientos y cebolla morada.', tienda: 'Drive Pizza' },
          { id: 'p17', nombre: 'Suprema', precio: 31900, img: 'images/Pizza_Suprema.png', descripcion: 'Carne, pepperoni, champi√±ones y pimientos.', tienda: 'The Pizza Company' },
          { id: 'p18', nombre: 'Campesina', precio: 24900, img: 'images/Pizza_Campesina.png', descripcion: 'Ma√≠z tierno, tocineta y cebolla blanca.', tienda: 'Oliva Pizza Garden' },
          { id: 'p19', nombre: 'Del Mar', precio: 33900, img: 'images/Pizza_Mar.png', descripcion: 'Camarones, calamar y toque de lim√≥n.', tienda: 'Drive Pizza' },
          { id: 'p20', nombre: 'Vegana', precio: 27900, img: 'images/Pizza_Vegana.png', descripcion: 'Base de tomate natural con vegetales frescos y queso vegano.', tienda: 'Oliva Pizza Garden' }
        ],
        bebidas: [
          { id: 'b1', nombre: 'Gaseosa 500ml', precio: 3900, img: 'images/Gaseosa.jpg', descripcion: 'Coca Cola o similar.' },
          { id: 'b2', nombre: 'Jugo Natural', precio: 4900, img: 'images/Jugo_Natural.jpg', descripcion: 'Jugo del d√≠a.' },
          { id: 'b3', nombre: 'Agua 600ml', precio: 2500, img: 'images/Agua_600ml.jpg', descripcion: 'Agua sin gas.' },
          { id: 'b4', nombre: 'Limonada', precio: 4500, img: 'images/Limonada.jpg', descripcion: 'Limonada fresca.' },
          { id: 'b5', nombre: 'T√© Helado', precio: 4200, img: 'images/T√©_Helado.jpg', descripcion: 'T√© fr√≠o con lim√≥n.' },
          { id: 'b6', nombre: 'Malteada Vainilla', precio: 7900, img: 'images/Malteada_Vainilla.jpg', descripcion: 'Malteada cremosa de vainilla.' },
          { id: 'b7', nombre: 'Malteada Chocolate', precio: 7900, img: 'images/Malteada_Chocolate.jpg', descripcion: 'Chocolate intenso.' },
          { id: 'b8', nombre: 'Cerveza 330ml', precio: 6900, img: 'images/Cerveza_330ml.jpg', descripcion: 'Cerveza nacional.' },
          { id: 'b9', nombre: 'C√≥ctel sin Alcohol', precio: 8500, img: 'images/C√≥ctel_sin_Alcohol.jpg', descripcion: 'Mezcla de frutas refrescante.' },
          { id: 'b10', nombre: 'Smoothie Energ√©tico', precio: 9200, img: 'images/Smoothie_Energ√©tico.jpg', descripcion: 'Frutas y prote√≠na.' },
          { id: 'b11', nombre: 'Caf√© Americano', precio: 3900, img: 'images/Caf√©_Americano.jpg', descripcion: 'Caf√© negro reci√©n preparado.' },
          { id: 'b12', nombre: 'Cappuccino', precio: 5900, img: 'images/Cappuccino.png', descripcion: 'Caf√© con espuma de leche y toque de canela.' },
          { id: 'b13', nombre: 'Chocolate Caliente', precio: 5200, img: 'images/Chocolate_Caliente.png', descripcion: 'Bebida espesa de cacao artesanal.' },
          { id: 'b14', nombre: 'Agua con Gas', precio: 2700, img: 'images/Agua_con_Gas.jpg', descripcion: 'Agua mineral gasificada.' },
          { id: 'b15', nombre: 'Limonada de Coco', precio: 5500, img: 'images/Limonada_de_Coco.jpg', descripcion: 'Limonada cremosa con coco natural.' },
          { id: 'b16', nombre: 'Jugo de Mango', precio: 4900, img: 'images/Jugo_de_Mango.jpg', descripcion: 'Jugo natural de mango maduro.' },
          { id: 'b17', nombre: 'Batido de Fresa', precio: 7400, img: 'images/Batido_de_Fresa.jpg', descripcion: 'Fresas frescas con leche fr√≠a.' },
          { id: 'b18', nombre: 'T√© Verde Fr√≠o', precio: 4300, img: 'images/T√©_Verde_Fr√≠o.jpg', descripcion: 'T√© verde con toque de miel y lim√≥n.' },
          { id: 'b19', nombre: 'Mojito sin Alcohol', precio: 8700, img: 'images/Mojito_sin_Alcohol.jpg', descripcion: 'Menta fresca, lim√≥n y soda.' },
          { id: 'b20', nombre: 'Jugo de Frutas Mixtas', precio: 5200, img: 'images/Jugo_de_Frutas_Mixtas.jpg', descripcion: 'Mezcla de frutas tropicales.' }

        ]
      };

      function renderProductos(categoria) {
        const grid = document.getElementById('productosGrid');
        const title = document.getElementById('productosTitle');
        if (!grid || !title) return;

        const lista = productosCatalogo[categoria] || [];
        title.textContent = categoria.charAt(0).toUpperCase() + categoria.slice(1);

        grid.innerHTML = '';

        if (lista.length === 0) {
          grid.innerHTML = '<p class="text-muted">No hay productos para esta categor√≠a.</p>';
          return;
        }

        lista.forEach(p => {
          const col = document.createElement('div');
          col.className = 'col-sm-6 col-md-4';
          col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${p.img}" class="card-img-top" alt="${p.nombre}" style="height:180px; object-fit:cover;">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${p.nombre}</h5>
            <p class="card-text text-muted small">${p.descripcion}</p>
            <div class="mt-auto d-flex justify-content-between align-items-center">
              <strong>$${p.precio.toLocaleString()}</strong>
              <button class="btn btn-outline-danger btn-sm agregar-carrito-por-id" data-id="${p.id}" data-nombre="${p.nombre}" data-precio="${p.precio}">Agregar</button>
            </div>
          </div>
        </div>
      `;
          grid.appendChild(col);
        });

        document.getElementById('productosSection').style.display = 'block';
        document.getElementById('productosSection').scrollIntoView({ behavior: 'smooth' });

        // listeners para botones agregados din√°micamente
        document.querySelectorAll('.agregar-carrito-por-id').forEach(btn => {
          btn.addEventListener('click', function () {
            const nombre = this.dataset.nombre;
            const precio = parseInt(this.dataset.precio) || 0;
            carrito.push({ nombre, precio });
            localStorage.setItem('carrito', JSON.stringify(carrito));
            if (typeof actualizarCarrito === 'function') actualizarCarrito();
            const original = this.innerHTML;
            this.innerHTML = 'Agregado';
            setTimeout(() => this.innerHTML = original, 900);
          });
        });
      }

      // click en tarjetas de categor√≠a
      document.querySelectorAll('.categoria-card').forEach(el => {
        el.addEventListener('click', function () {
          const categoria = this.dataset.categoria;
          renderProductos(categoria);
        });
      });

      // bot√≥n volver
      const volverBtn = document.getElementById('volverCategoriasBtn');
      if (volverBtn) {
        volverBtn.addEventListener('click', function () {
          document.getElementById('productosSection').style.display = 'none';
          document.querySelector('.seccion-categorias').scrollIntoView({ behavior: 'smooth' });
        });
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const STORE_REP = 'repartidores';
      if (!localStorage.getItem(STORE_REP)) localStorage.setItem(STORE_REP, JSON.stringify([]));
      function saveRepartidores(arr) { localStorage.setItem(STORE_REP, JSON.stringify(arr)); }
      function getRepartidores() { return JSON.parse(localStorage.getItem(STORE_REP) || '[]'); }
      function uid(prefix = 'r') { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8); }


      window.createRepartidor = function (data) {
        const arr = getRepartidores();
        const newR = Object.assign({ id: data.id || uid('r'), nombre: data.nombre || 'Repartidor', telefono: data.telefono || '', activo: true, disponible: true }, data);
        arr.push(newR);
        saveRepartidores(arr);
        return newR;
      };
      window.getRepartidor = function (id) { return getRepartidores().find(r => r.id === id) || null; };
      window.updateRepartidor = function (id, patch) {
        const arr = getRepartidores(); const i = arr.findIndex(r => r.id === id); if (i === -1) return null;
        arr[i] = Object.assign({}, arr[i], patch, { updatedAt: new Date().toISOString() }); saveRepartidores(arr); return arr[i];
      };
      window.deleteRepartidor = function (id) { const arr = getRepartidores().filter(r => r.id !== id); saveRepartidores(arr); return true; };
      window.listRepartidores = getRepartidores;


      function _getPedidosGlobales() { return JSON.parse(localStorage.getItem('pedidosGlobales') || '[]'); }
      function _savePedidosGlobales(arr) { localStorage.setItem('pedidosGlobales', JSON.stringify(arr)); }
      function _savePedidoPorUsuario(email, pedido) {
        const porUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario') || '{}');
        porUsuario[email] = porUsuario[email] || [];
        const idx = porUsuario[email].findIndex(p => p.id === pedido.id);
        if (idx >= 0) porUsuario[email][idx] = pedido; else porUsuario[email].push(pedido);
        localStorage.setItem('pedidosPorUsuario', JSON.stringify(porUsuario));
      }


      window.assignOrderToRepartidor = function (pedidoId, repartidorId) {
        const pedidos = _getPedidosGlobales();
        const pidx = pedidos.findIndex(p => p.id === pedidoId || p.paypalOrderId === pedidoId);
        if (pidx === -1) return null;
        pedidos[pidx].repartidorId = repartidorId; pedidos[pidx].estado = 'asignado';
        pedidos[pidx].historial = pedidos[pidx].historial || []; pedidos[pidx].historial.push({ evento: 'asignado', repartidorId, at: new Date().toISOString() });
        _savePedidosGlobales(pedidos);
        const cliente = pedidos[pidx].cliente || localStorage.getItem('loggedUser') || 'invitado';
        _savePedidoPorUsuario(cliente, pedidos[pidx]);
        return pedidos[pidx];
      };


      window.repartidorAcceptOrder = function (pedidoId, repartidorId) {
        const pedidos = _getPedidosGlobales();
        const p = pedidos.find(p => p.id === pedidoId || p.paypalOrderId === pedidoId);
        if (!p) return null;
        if (p.repartidorId && p.repartidorId !== repartidorId) return { error: 'Pedido asignado a otro repartidor' };
        p.estado = 'aceptado'; p.historial = p.historial || []; p.historial.push({ evento: 'aceptado', repartidorId, at: new Date().toISOString() });
        _savePedidosGlobales(pedidos); _savePedidoPorUsuario(p.cliente || localStorage.getItem('loggedUser') || 'invitado', p);
        updateRepartidor(repartidorId, { disponible: false }); renderPedidosRepartidor();
        return p;
      };


      window.updateOrderStatus = function (pedidoId, status, meta = {}) {
        const pedidos = _getPedidosGlobales();
        const p = pedidos.find(p => p.id === pedidoId || p.paypalOrderId === pedidoId);
        if (!p) return null;
        p.estado = status; p.historial = p.historial || []; p.historial.push(Object.assign({ evento: status, at: new Date().toISOString() }, meta));
        if (status === 'entregado') { p.entregadoEn = new Date().toISOString(); if (p.repartidorId) updateRepartidor(p.repartidorId, { disponible: true }); }
        _savePedidosGlobales(pedidos); _savePedidoPorUsuario(p.cliente || localStorage.getItem('loggedUser') || 'invitado', p); renderPedidosRepartidor(); return p;
      };


      window.repartidorConfirmDelivery = function (pedidoId, repartidorId) { return updateOrderStatus(pedidoId, 'entregado', { repartidorId }); };
      window.listPedidosPorRepartidor = function (repartidorId) { return _getPedidosGlobales().filter(p => p.repartidorId === repartidorId); };


      if (getRepartidores().length === 0) {
        createRepartidor({ id: 'r_juan', nombre: 'Juan P√©rez', telefono: '+573001112223', disponible: true });
        createRepartidor({ id: 'r_maria', nombre: 'Mar√≠a Gomez', telefono: '+573004445556', disponible: true });
      }


      window.renderPedidosRepartidor = function () {
        const list = document.getElementById('repartidorPedidosList'); if (!list) return;
        const logged = localStorage.getItem('loggedUser');
        const users = JSON.parse(localStorage.getItem('users') || '{}'); const user = users[logged] || {};
        const repartidorId = user.repartidorId || logged || '';
        const pedidos = _getPedidosGlobales().filter(p => (repartidorId && p.repartidorId === repartidorId) || p.estado === 'pagado' || p.estado === 'asignado' || p.estado === 'pendiente');
        list.innerHTML = ''; if (!pedidos.length) { list.innerHTML = '<div class="text-muted">No hay pedidos por ahora.</div>'; return; }
        pedidos.forEach(p => {
          const el = document.createElement('div'); el.className = 'list-group-item';
          el.innerHTML = `<div class="d-flex justify-content-between align-items-start"><div><strong>${p.cliente || (p.comprador && p.comprador.email) || 'invitado'}</strong> ‚Äî ${p.fecha || ''}<div class="small text-muted">${p.direccion || ''}</div><div class="small">Productos: ${p.productos?.map(x => x.nombre).join(', ') || ''}</div></div><div class="text-end"><div class="mb-2"><span class="badge bg-info text-dark">${p.estado || 'pendiente'}</span></div><button class="btn btn-sm btn-success me-1" onclick="repartidorAcceptOrder('${p.id || p.paypalOrderId}', '${repartidorId || ''}')">Aceptar</button><button class="btn btn-sm btn-warning me-1" onclick="updateOrderStatus('${p.id || p.paypalOrderId}','en_ruta',{repartidorId:'${repartidorId || ''}'})">En ruta</button><button class="btn btn-sm btn-danger" onclick="repartidorConfirmDelivery('${p.id || p.paypalOrderId}','${repartidorId || ''}')">Entregado</button></div></div>`;
          list.appendChild(el);
        });
      };
      document.getElementById('repartidorModal')?.addEventListener('show.bs.modal', function () { renderPedidosRepartidor(); });
      console.info('M√≥dulo repartidor inicializado.');
    })();
  </script>



  <script>


    // Funciones de reportes
    function calcularIngresosMensuales() {
      const pedidos = JSON.parse(localStorage.getItem('pedidosGlobales') || '[]');
      const ingresos = {};

      pedidos.forEach(p => {
        const tienda = p.tienda || "sin_tienda";
        const fecha = new Date(p.fecha);
        const mes = fecha.getMonth() + 1;
        const anio = fecha.getFullYear();
        const clave = `${tienda}-${anio}-${mes}`;

        if (!ingresos[clave]) {
          ingresos[clave] = { tienda, anio, mes, total: 0 };
        }
        ingresos[clave].total += p.total;
      });

      return Object.values(ingresos);
    }

    // Funci√≥n para calcular clientes frecuentes por tienda
    function clientesFrecuentesPorTienda() {
      const pedidos = JSON.parse(localStorage.getItem('pedidosGlobales') || '[]');
      const clientes = {};

      pedidos.forEach(p => {
        const tienda = p.tienda || "sin_tienda";
        const cliente = p.cliente || "invitado";
        if (!clientes[tienda]) clientes[tienda] = {};
        if (!clientes[tienda][cliente]) clientes[tienda][cliente] = 0;
        clientes[tienda][cliente]++;
      });

      const resultado = {};
      for (const tienda in clientes) {
        resultado[tienda] = Object.entries(clientes[tienda])
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
      }
      return resultado;
    }

    // Renderizar tablas al abrir el modal de reportes
    document.addEventListener('DOMContentLoaded', function () {
      const reportesModal = document.getElementById('reportesModal');
      if (reportesModal) {
        reportesModal.addEventListener('shown.bs.modal', function () {
          const ingresos = calcularIngresosMensuales();
          const clientes = clientesFrecuentesPorTienda();

          // Tabla de ingresos
          let htmlIngresos = `<table class="table table-striped">
          <thead><tr><th>Tienda</th><th>A√±o</th><th>Mes</th><th>Total</th></tr></thead><tbody>`;
          ingresos.forEach(i => {
            htmlIngresos += `<tr><td>${i.tienda}</td><td>${i.anio}</td><td>${i.mes}</td><td>$${i.total.toLocaleString()}</td></tr>`;
          });
          htmlIngresos += `</tbody></table>`;
          document.getElementById('tablaIngresos').innerHTML = htmlIngresos;

          // Tabla de clientes frecuentes
          let htmlClientes = "";
          for (const tienda in clientes) {
            htmlClientes += `<h6>${tienda}</h6><ul>`;
            clientes[tienda].forEach(([cliente, veces]) => {
              htmlClientes += `<li>${cliente} (${veces} pedidos)</li>`;
            });
            htmlClientes += `</ul>`;
          }
          document.getElementById('tablaClientes').innerHTML = htmlClientes;
        });
      }
    });
    function coberturaGeograficaDesdeDOM() {
      const cards = document.querySelectorAll("#te-sugerimos .card");
      const cobertura = {};

      cards.forEach(card => {
        // Nombre de la tienda (primer <p> en la tarjeta)
        const nombre = card.querySelector("p").textContent.trim();

        // Extraer direcci√≥n del enlace (ejemplo: "Cra 44 # 37 - 10 / Tulu√° Valle")
        const direccion = card.querySelector("a").textContent.trim();

        // Aqu√≠ asumimos que el √∫ltimo t√©rmino es el municipio y el pen√∫ltimo es el departamento
        // Puedes ajustar seg√∫n tu formato
        const partes = direccion.split(" ");
        const municipio = partes[partes.length - 2] || "Municipio desconocido";
        const departamento = partes[partes.length - 1] || "Departamento desconocido";

        if (!cobertura[departamento]) cobertura[departamento] = [];
        cobertura[departamento].push({ nombre, municipio });
      });

      return cobertura;
      function guardarPedido(tienda, cliente, total) {
        // Recuperar pedidos existentes
        let pedidos = JSON.parse(localStorage.getItem("pedidosGlobales") || "[]");

        // Crear nuevo pedido
        const nuevoPedido = {
          tienda,
          cliente,
          fecha: new Date().toISOString(),
          total
        };

        // Agregar al array
        pedidos.push(nuevoPedido);

        // Guardar en localStorage
        localStorage.setItem("pedidosGlobales", JSON.stringify(pedidos));
      }

    }


    document.addEventListener("DOMContentLoaded", function () {
      const reportesModal = document.getElementById("reportesModal");
      if (reportesModal) {
        reportesModal.addEventListener("shown.bs.modal", function () {
          const cobertura = coberturaGeograficaDesdeDOM();

          let htmlCobertura = "";
          for (const depto in cobertura) {
            htmlCobertura += `<h6>${depto}</h6><ul>`;
            cobertura[depto].forEach(t => {
              htmlCobertura += `<li>${t.nombre} ‚Äî ${t.municipio}</li>`;
            });
            htmlCobertura += `</ul>`;
          }

          document.getElementById("tablaCobertura").innerHTML = htmlCobertura;
        });
      }
      document.addEventListener("DOMContentLoaded", function () {
        const finalizarBtn = document.getElementById("finalizarCompraBtn");

        if (finalizarBtn) {
          finalizarBtn.addEventListener("click", function () {
            // Aqu√≠ obtienes los datos reales del carrito
            const tiendaSeleccionada = "Pizza Garden"; // puedes cambiar seg√∫n el contexto
            const cliente = localStorage.getItem("loggedUser"); // correo del usuario logueado
            const totalCarrito = parseInt(document.getElementById("carritoTotal").textContent) || 0;

            if (!cliente) {
              alert("Debes iniciar sesi√≥n para finalizar la compra.");
              return;
            }

            guardarPedido(tiendaSeleccionada, cliente, totalCarrito);

            alert("¬°Compra registrada correctamente!");
            bootstrap.Modal.getOrCreateInstance(document.getElementById("carritoModal")).hide();
          });
        }
      });

    });

  </script>
</body>

</html>