<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pedidos YEMM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="styles/style.css">
</head>

<body class="d-flex flex-column min-vh-100">
   <!-- Header -->
<header class="bg-light py-4 px-3 border-bottom shadow-sm">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center flex-wrap">

      <!-- Logo -->
      <div class="d-flex align-items-center me-auto">
        <img src="images/LogoPedidos.png" alt="PEDIDOS YEMM" class="logo-img me-2" style="height: 60px;">
        <span class="fw-bold text-danger fs-4">PEDIDOS YEMM</span>
      </div>

      <!-- Botón Ver Carrito -->
      <button class="btn btn-outline-dark ms-4" data-bs-toggle="modal" data-bs-target="#carritoModal">
        <i class="bi bi-cart"></i> Ver Carrito
      </button>

      <!-- Search Bar + Dirección -->
      <div class="d-flex align-items-center flex-grow-1 justify-content-center">
        <button class="btn btn-outline-danger btn-ingresar-direccion" data-bs-toggle="modal"
          data-bs-target="#direccionModal">Ingresar dirección</button>
        <div class="input-group ms-3" style="max-width: 300px;">
          <input type="text" class="form-control rounded-pill" placeholder="Buscar locales">
          <button class="btn btn-danger rounded-pill ms-2">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Perfil -->
      <div class="d-flex align-items-center ms-3">
        <a href="#" class="text-dark" id="profileBtn" role="button">
          <i class="bi bi-person"></i> Mi Perfil
        </a>
      </div>

    </div>
  </div>
</header>


    <div class="promo-marquee">
        <div class="promo-marquee-track">
            <span>🎉 ¡Aprovecha nuestras promociones de lanzamiento! 2x1 en pizzas, bebidas gratis y mucho más.
                🎉</span>
            <span>🎉 ¡Aprovecha nuestras promociones de lanzamiento! 2x1 en pizzas, bebidas gratis y mucho más.
                🎉</span>
        </div>
    </div>

    <!-- Modal para ingresar dirección -->
    <div class="modal fade" id="direccionModal" tabindex="-1" aria-labelledby="direccionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="direccionModalLabel">Ingresar Dirección</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="direccionForm">
                        <div class="mb-3">
                            <label for="calle" class="form-label">Calle y número</label>
                            <input type="text" class="form-control" id="calle"
                                placeholder="Ejemplo: Av. Siempre Viva 742">
                        </div>
                        <div class="mb-3">
                            <label for="ciudad" class="form-label">Ciudad</label>
                            <input type="text" class="form-control" id="ciudad" placeholder="Ejemplo: Cali">
                        </div>
                        <div class="mb-3">
                            <label for="provincia" class="form-label">Departamento</label>
                            <input type="text" class="form-control" id="departamento"
                                placeholder="Ejemplo: Valle del Cauca">
                        </div>
                        <div class="mb-3">
                            <label for="codigoPostal" class="form-label">Código Postal</label>
                            <input type="text" class="form-control" id="codigoPostal" placeholder="Ejemplo: 1000">
                        </div>

                        <!-- botones: guardar/actualizar y eliminar (eliminar sólo si ya hay dirección) -->
                        <div class="d-flex gap-2">
                          <button type="submit" class="btn btn-danger w-100" id="guardarDireccionBtn">Guardar Dirección</button>
                          <button type="button" class="btn btn-outline-danger" id="eliminarDireccionBtn" style="display:none;">Eliminar dirección</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Iniciar sesión o Registrarse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Correo electrónico</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div id="registerFields" style="display:none;">
                            <div class="mb-3">
                                <label for="registerName" class="form-label">Nombre completo</label>
                                <input type="text" class="form-control" id="registerName">
                            </div>
                        </div>
                        <!-- Campo de tipo de usuario -->
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Tipo de usuario</label>
                            <select class="form-select" id="userRole" required>
                                <option value="">Selecciona tu rol</option>
                                <option value="cliente">Cliente</option>
                                <option value="repartidor">Repartidor</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="submit" class="btn btn-danger" id="loginBtn">Iniciar sesión</button>
                            <button type="button" class="btn btn-outline-secondary"
                                id="toggleRegisterBtn">Registrarse</button>
                        </div>
                    </form>
                    <div id="loginMessage" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nuevo Modal de Perfil de Usuario -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">Mi Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <img id="profilePhoto" src="https://via.placeholder.com/90x90?text=Foto"
                            class="rounded-circle mb-2" style="width:90px;height:90px;object-fit:cover;">
                        <input type="file" id="photoInput" accept="image/*" class="form-control form-control-sm mx-auto"
                            style="max-width:180px;">
                    </div>
                    <h6 id="profileName"></h6>
                    <p id="profileEmail" class="mb-1"></p>
                    <hr>
                    <h6>Direcciones registradas</h6>
                    <ul id="profileAddresses" class="list-group mb-3"></ul>
                    <button class="btn btn-outline-danger btn-sm mb-2" id="logoutBtn">Cerrar sesión</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container my-5 flex-fill">
        <!-- Imagen de fondo -->
        <section class="hero-bg mb-5 position-relative">
            <img src="images/fondo.jpg" alt="Fondo" class="w-100 hero-img">
            <div class="hero-text hero-text-left">
                <h1 class="display-6 fw-bold text-white mb-3">
                    ¡Bienvenido a <span style="color:#ffd600;">PEDIDOS YEMM</span>!
                </h1>
                <p class="lead text-white mb-1" style="max-width: 600px;">
                    Descubre los mejores sabores de tu ciudad. <span style="color:#ffd600;">Promociones
                        exclusivas</span>, <span style="color:#ffd600;">entrega rápida</span> y <span
                        style="color:#ffd600;">tus restaurantes favoritos</span> a solo un clic.
                </p>
                <a href="#te-sugerimos" class="btn btn-warning btn-lg fw-bold shadow mt-0">Explora opciones</a>
            </div>
        </section>

        <!-- Sección de categorías, ahora ancho completo y sin espacio arriba -->
        <section class="seccion-categorias py-5"
            style="margin-top:0; width:100vw; position:relative; left:50%; right:50%; margin-left:-50vw; margin-right:-50vw;">
            <h2 class="titulo-antojo">¿Qué se te antoja hoy?</h2>
            <div class="row justify-content-center text-center g-4">
                <div class="col-md-2">
                    <img src="images/Hamburguesa.jpg" alt="Hamburguesas" class="img-fluid rounded-circle shadow">
                    <p class="mt-2 fw-semibold">Hamburguesas</p>
                </div>
                <div class="col-md-2">
                    <img src="images/Pizza.jpeg" alt="Pizzas" class="img-fluid rounded-circle shadow">
                    <p class="mt-2 fw-semibold">Pizzas</p>
                </div>
                <div class="col-md-2">
                    <img src="images/bebidas.jpeg" alt="Bebidas" class="img-fluid rounded-circle shadow">
                    <p class="mt-2 fw-semibold">Bebidas</p>
                </div>
            </div>
        </section>
        <!-- Sección de Promociones -->
        <section class="seccion-promociones text-center py-5">
            <div class="container">
                <h2 class="titulo-antojo mb-4">🔥 ¡Promociones del Día! 🔥</h2>
                <p class="fs-5 fw-bold mb-5 text-dark">
                    ¡No dejes pasar estas ofertas irresistibles! Solo por tiempo limitado.
                </p>

                <div class="row justify-content-center g-4">
                    <!-- Promo 1 -->
                    <div class="col-md-4">
                        <div class="card promo-card shadow-lg border-0 rounded-4">
                            <div class="card-body text-center">
                                <img src="images/promo1.png" alt="Promo Pizza" class="img-fluid rounded-4 mb-3"
                                    style="height:200px; object-fit:cover;">
                                <h5 class="fw-bold text-danger">2x1 en Pizzas Familiares 🍕</h5>
                                <p class="text-muted mb-3">Todos los martes y jueves. ¡Para compartir!</p>
                                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¡Pídela Ya!</a>

                                <!-- Botón para agregar al carrito -->
                                <button class="btn btn-outline-danger mt-2 agregar-carrito"
                                    data-nombre="Pizza Familiar 2x1" data-precio="29900">
                                    Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Promo 2 -->
                    <div class="col-md-4">
                        <div class="card promo-card shadow-lg border-0 rounded-4">
                            <div class="card-body text-center">
                                <img src="images/promo2.webp" alt="Promo Burger" class="img-fluid rounded-4 mb-3"
                                    style="height:200px; object-fit:cover;">
                                <h5 class="fw-bold text-danger">Combo Burger + Bebida 🥤</h5>
                                <p class="text-muted mb-3">Llévate una burger premium + bebida por solo <b>$19.900</b>.
                                </p>
                                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¡Quiero el combo!</a>

                                <!-- Botón para agregar al carrito -->
                                <button class="btn btn-outline-danger mt-2 agregar-carrito"
                                    data-nombre="Combo Burger + Bebida" data-precio="19900">
                                    Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- Promo 3 -->
                    <div class="col-md-4">
                        <div class="card promo-card shadow-lg border-0 rounded-4">
                            <div class="card-body text-center">
                                <img src="images/promo3.jpg" alt="Promo Postre" class="img-fluid rounded-4 mb-3"
                                    style="height:200px; object-fit:cover;">
                                <h5 class="fw-bold text-danger">Postre GRATIS 🍨</h5>
                                <p class="text-muted mb-3">En compras superiores a $30.000. ¡Dulce tentación
                                    garantizada!</p>
                                <a href="#" class="btn btn-dark fw-bold rounded-pill px-4">¡Endúlzate!</a>

                                <!-- Botón para agregar al carrito -->
                                <button class="btn btn-outline-danger mt-2 agregar-carrito" data-nombre="Postre GRATIS"
                                    data-precio="0">
                                    Agregar al carrito
                                </button>
                            </div>
                        </div>
                    </div>
        </section>


        <!-- Nueva sección para "Te sugerimos" -->
        <section class="seccion-sugerencias">
            <div class="container text-center">
                <h2 class="titulo-antojo">Te sugerimos</h2>
                <div class="row justify-content-center g-4">

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/pizza_company.jpg" alt="The Pizza Company"
                                    class="img-fluid mb-2 rounded-4" style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    The Pizza Company <br>📍Caravans - Cra 44 # 37 - 10 / Tuluá Valle <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@thepizzacompanyco
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/Pizza_Drive.jpg" alt="Drive Pizza" class="img-fluid mb-2 rounded-4"
                                    style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    Drive Pizza <br>📍Calle 26 # 35 - 41 B/ Alvernia <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@drivepizzatulua_
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/Pizza_Garden.jpg" alt="Oliva Pizza Garden"
                                    class="img-fluid mb-2 rounded-4" style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    Oliva Pizza Garden <br>📍Cra 40 # 35 - Esquina B/ Lomitas <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@olivapizzagarden
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/Ham_Ata.jpg" alt="ATA Burger" class="img-fluid mb-2 rounded-4"
                                    style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    ATA <br>📍Cra 26 # 37 - 51 B/ Salesianos <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@ataburgerexpress
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/Ham_Smash.jpg" alt="Smash Burger" class="img-fluid mb-2 rounded-4"
                                    style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    Smash Burger <br>📍Containers Park, Tuluá <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@smashburger.tulua
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card h-100 shadow rounded-4">
                            <div class="card-body text-center">
                                <img src="images/Ham_Burger.jpg" alt="La Burger" class="img-fluid mb-2 rounded-4"
                                    style="max-height:200px; object-fit:cover;">
                                <p class="fw-bold mb-0">
                                    La Burger <br>📍Cra 26 #39 - 16 B/ El Príncipe Tuluá <br>
                                    <i class="bi bi-instagram me-1"
                                        style="font-size:1.4rem; color:#E1306C;"></i>@laburger.col
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>
    <!-- Footer -->
  <footer class="bg-dark text-white pt-4 pb-0 mt-auto">
    <div class="container">
      <div class="row text-start">
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Enlaces rápidos</h5>
          <ul class="list-unstyled">
            <li>Explorar productos</li>
            <li>Tiendas cercanas</li>
            <li>Conocer más</li>
          </ul>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Redes sociales</h5>
          <div class="d-flex gap-2">
            <img src="images/facebook.png" alt="Facebook" style="width:32px; height:32px;">
            <img src="images/tiktok.png" alt="TikTok" style="width:32px; height:32px;">
            <img src="images/twitter.png" alt="Twitter" style="width:32px; height:32px;">
            <img src="images/instagram.png" alt="Instagram" style="width:32px; height:32px;">
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Contacto</h5>
          <p class="mb-0">
            <a href="mailto:info@redelivery.com" class="text-white text-decoration-none">info@redelivery.com</a><br>
            <a href="tel:+573001234567" class="text-white text-decoration-none">📞 +57 300 123 4567</a>
          </p>
        </div>
        <div class="col-md-3 mb-3">
          <h5 class="fw-bold">Información legal</h5>
          <ul class="list-unstyled">
            <li>Términos y condiciones</li>
            <li>Política de privacidad</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Franja inferior: color distinto para que "derechos reservados" se vea -->
    <div class="footer-bottom mt-4 py-3 text-center" style="background-color:#e77b16; color:#111;">
      <p class="mb-0 small fw-semibold">©️ 2025 PedidosYEMM. Todos los derechos reservados.</p>
    </div>
  </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Guardar y verificar usuarios en localStorage
        document.addEventListener('DOMContentLoaded', function () {
            const loginForm = document.getElementById('loginForm');
            const toggleRegisterBtn = document.getElementById('toggleRegisterBtn');
            const registerFields = document.getElementById('registerFields');
            const loginBtn = document.getElementById('loginBtn');
            const loginMessage = document.getElementById('loginMessage');
            let isRegister = false;

            if (toggleRegisterBtn) {
              toggleRegisterBtn.addEventListener('click', function () {
                  isRegister = !isRegister;
                  registerFields.style.display = isRegister ? 'block' : 'none';
                  loginBtn.textContent = isRegister ? 'Registrarse' : 'Iniciar sesión';
                  toggleRegisterBtn.textContent = isRegister ? 'Ya tengo cuenta' : 'Registrarse';
                  loginMessage.textContent = '';
              });
            }

            if (loginForm) {
              loginForm.addEventListener('submit', function (e) {
                  e.preventDefault();
                  const email = document.getElementById('loginEmail').value;
                  const password = document.getElementById('loginPassword').value;
                  const name = document.getElementById('registerName').value;

                  let users = JSON.parse(localStorage.getItem('users') || '{}');

                  if (isRegister) {
                      if (!name) {
                          loginMessage.textContent = 'Por favor ingresa tu nombre.';
                          loginMessage.style.color = 'red';
                          return;
                      }
                      if (users[email]) {
                          loginMessage.textContent = 'El usuario ya está registrado.';
                          loginMessage.style.color = 'red';
                      } else {
                          users[email] = { password, name };
                          localStorage.setItem('users', JSON.stringify(users));
                          loginMessage.textContent = '¡Registro exitoso! Ahora puedes iniciar sesión.';
                          loginMessage.style.color = 'green';
                          isRegister = false;
                          registerFields.style.display = 'none';
                          loginBtn.textContent = 'Iniciar sesión';
                          toggleRegisterBtn.textContent = 'Registrarse';
                      }
                  } else {
                      if (users[email] && users[email].password === password) {
                          loginMessage.textContent = `¡Bienvenido, ${users[email].name || 'usuario'}!`;
                          loginMessage.style.color = 'green';

                          // guardar sesión
                          localStorage.setItem('loggedUser', email);

                          // actualizar estado global/currentUser y texto del botón perfil inmediatamente
                          currentUser = users[email];
                          currentUser.email = email;
                          const profileBtn = document.getElementById('profileBtn');
                          if (profileBtn) profileBtn.innerHTML = `<i class="bi bi-person"></i> ${users[email].name || 'Mi Perfil'}`;

                          setTimeout(() => {
                              bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).hide();
                              // eliminar backdrops sobrantes por seguridad y quitar clase modal-open
                              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                              document.body.classList.remove('modal-open');
                          }, 1000);
                      } else {
                          loginMessage.textContent = 'Correo o contraseña incorrectos.';
                          loginMessage.style.color = 'red';
                      }
                  }
              });
            }

            // Actualizar texto del botón de perfil si hay sesión activa
            const logged = localStorage.getItem('loggedUser');
            if (logged) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[logged];
                if (user) {
                    const btn = document.getElementById('profileBtn');
                    if (btn) btn.innerHTML = `<i class="bi bi-person"></i> ${user.name || 'Mi Perfil'}`;
                }
            }
        });

        let currentUser = null;

   function showProfileModal(user) {
  // limpiar cualquier historial de pedidos previamente añadido para evitar duplicados
  const modalBody = document.getElementById('profileModal').querySelector('.modal-body');
  const existingPedidos = modalBody.querySelector('.profile-pedidos-container');
  if (existingPedidos) existingPedidos.remove();

  document.getElementById('profileName').textContent = user.name || '';
  document.getElementById('profileEmail').textContent = user.email || '';

  // Foto
  const photo = user.photo || 'https://via.placeholder.com/90x90?text=Foto';
  document.getElementById('profilePhoto').src = photo;

  // Direcciones
  const addresses = user.addresses || [];
  const ul = document.getElementById('profileAddresses');
  ul.innerHTML = '';
  if (addresses.length === 0) {
    ul.innerHTML = '<li class="list-group-item">No hay direcciones registradas.</li>';
  } else {
    addresses.forEach(addr => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = addr;
      ul.appendChild(li);
    });
  }

  // 🧾 Historial de pedidos
  const pedidosPorUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario')) || {};
  const pedidos = pedidosPorUsuario[user.email] || [];

  const pedidosContainer = document.createElement('div');
  pedidosContainer.className = 'mt-4 profile-pedidos-container';
  pedidosContainer.innerHTML = '<h6>🧾 Historial de pedidos</h6>';

  if (pedidos.length === 0) {
    pedidosContainer.innerHTML += '<p class="text-muted">No hay pedidos registrados.</p>';
  } else {
    const ulPedidos = document.createElement('ul');
    ulPedidos.className = 'list-group';
    pedidos.forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `
        <strong>${p.fecha}</strong><br>
        Productos: ${p.productos.map(prod => prod.nombre).join(', ')}<br>
        Total: $${p.total.toLocaleString()}<br>
        Dirección: ${p.direccion}
      `;
      ulPedidos.appendChild(li);
    });
    pedidosContainer.appendChild(ulPedidos);
  }

  modalBody.appendChild(pedidosContainer);

  // Mostrar modal usando getOrCreateInstance para evitar instancias duplicadas/backdrop stuck
  bootstrap.Modal.getOrCreateInstance(document.getElementById('profileModal')).show();
}

        // Guardar foto de perfil
        const photoInputEl = document.getElementById('photoInput');
        if (photoInputEl) {
          photoInputEl.addEventListener('change', function (e) {
              const file = e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = function (evt) {
                  document.getElementById('profilePhoto').src = evt.target.result;
                  // Guardar en localStorage
                  let users = JSON.parse(localStorage.getItem('users') || '{}');
                  if (currentUser && users[currentUser.email]) {
                      users[currentUser.email].photo = evt.target.result;
                      localStorage.setItem('users', JSON.stringify(users));
                  }
              };
              reader.readAsDataURL(file);
          });
        }

        // Botón perfil: muestra login o perfil según sesión
        const profileBtnEl = document.getElementById('profileBtn');
        if (profileBtnEl) {
          profileBtnEl.addEventListener('click', function (e) {
              e.preventDefault();
              const logged = localStorage.getItem('loggedUser');
              if (logged) {
                  const users = JSON.parse(localStorage.getItem('users') || '{}');
                  const user = users[logged];
                  if (user) {
                      user.email = logged;
                      currentUser = user;
                      showProfileModal(user);
                      return;
                  }
              }
              // Si no está logueado, muestra login (usar getOrCreateInstance)
              bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).show();
          });
        }

        // Cerrar sesión
        const logoutBtnEl = document.getElementById('logoutBtn');
        if (logoutBtnEl) {
          logoutBtnEl.addEventListener('click', function () {
              localStorage.removeItem('loggedUser');

              // reset UI y estado local para permitir nuevo inicio de sesión
              currentUser = null;
              const profileBtn = document.getElementById('profileBtn');
              if (profileBtn) profileBtn.innerHTML = `<i class="bi bi-person"></i> Mi Perfil`;

              // limpiar modal de perfil para que no muestre datos viejos
              const profileNameEl = document.getElementById('profileName');
              const profileEmailEl = document.getElementById('profileEmail');
              if (profileNameEl) profileNameEl.textContent = '';
              if (profileEmailEl) profileEmailEl.textContent = '';
              const profilePhotoEl = document.getElementById('profilePhoto');
              if (profilePhotoEl) profilePhotoEl.src = 'https://via.placeholder.com/90x90?text=Foto';
              const profileAddressesEl = document.getElementById('profileAddresses');
              if (profileAddressesEl) profileAddressesEl.innerHTML = '';

              bootstrap.Modal.getOrCreateInstance(document.getElementById('profileModal')).hide();
              // limpieza por si queda backdrop
              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
              document.body.classList.remove('modal-open');
          });
        }
    </script>

    <!-- Modal Carrito -->
<div class="modal fade" id="carritoModal" tabindex="-1" aria-labelledby="carritoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="carritoModalLabel">🛒 Tu Carrito</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ul id="carritoLista" class="list-group mb-3"></ul>
        <h5 class="text-end">Total: <span id="carritoTotal">$0</span></h5>

        <div class="d-grid gap-2">
          <button class="btn btn-danger" id="confirmarPedidoBtn">Confirmar Pedido</button>
          <!-- Contenedor para el botón de PayPal -->
          <div id="paypal-button-container" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST: notificación cuando falta dirección -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
  <div id="toastNoDireccion" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Debes ingresar una dirección antes de confirmar el pedido.
      </div>
      <button type="button" class="btn btn-sm btn-outline-dark me-2 mt-1" id="abrirDireccionFromToast">Ingresar dirección</button>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
  </div>
</div>

<script>
  // CARRITO
  let carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
  // mantener referencia global por compatibilidad con partes del código que usan window.carrito
  window.carrito = carrito;

  function actualizarCarrito() {
    const lista = document.getElementById('carritoLista');
    const total = document.getElementById('carritoTotal');
    if (!lista || !total) return;
    lista.innerHTML = '';
    let suma = 0;

    carrito.forEach((item, index) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        ${item.nombre} - $${item.precio}
        <button class="btn btn-sm btn-outline-danger" onclick="eliminarDelCarrito(${index})">Eliminar</button>
      `;
      lista.appendChild(li);
      suma += Number(item.precio) || 0;
    });

    total.textContent = `$${suma.toLocaleString()}`;
    localStorage.setItem('carrito', JSON.stringify(carrito));
    // sincronizar window.carrito
    window.carrito = carrito;
  }

  function eliminarDelCarrito(index) {
    carrito.splice(index, 1);
    actualizarCarrito();
  }

  document.querySelectorAll('.agregar-carrito').forEach(btn => {
    btn.addEventListener('click', function () {
      const nombre = this.dataset.nombre;
      const precio = parseInt(this.dataset.precio) || 0;
      carrito.push({ nombre, precio });
      actualizarCarrito();
    });
  });

  // Init carrito view on load
  actualizarCarrito();
</script>

<!-- PayPal SDK: UNA sola inclusión (tu client-id) -->
<script src="https://www.paypal.com/sdk/js?client-id=AezkTw_Rnc_YxwEh_mTwsJofzRnmPQab0Bwmh6_ZJ-BfidkEul1814c5J1i0ONcVZIZ0Tdmmr4YbelgF&currency=USD"></script>

<script>
  // Control de renderizado
  window.__paypalButtonsReady = false;
  window.__paypalButtonElement = null;

  // Espera a que window.paypal esté disponible (timeout)
  function waitForPaypalSdk(timeoutMs = 5000) {
    return new Promise((resolve, reject) => {
      if (window.paypal) return resolve();
      const start = Date.now();
      const iv = setInterval(() => {
        if (window.paypal) {
          clearInterval(iv);
          return resolve();
        }
        if (Date.now() - start > timeoutMs) {
          clearInterval(iv);
          return reject(new Error('PayPal SDK no cargó en el tiempo esperado'));
        }
      }, 100);
    });
  }

  function initPayPalButtons() {
    if (window.__paypalButtonsReady) return Promise.resolve();

    return waitForPaypalSdk(7000)
      .then(() => {
        const container = document.getElementById('paypal-button-container');
        if (!container) {
          throw new Error('No existe #paypal-button-container');
        }
        // limpiar antes de renderizar
        container.innerHTML = '';

        return paypal.Buttons({
          style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'pay' },

          createOrder: function (data, actions) {
            try {
              const carritoLocal = JSON.parse(localStorage.getItem('carrito') || '[]');

              if (!carritoLocal.length) {
                alert('Tu carrito está vacío.');
                return Promise.reject(new Error('Carrito vacío'));
              }

              // verificar dirección: preferir localStorage, si no tomar la primera del perfil en users
              let direccionSeleccionada = localStorage.getItem('direccion') || '';
              if (!direccionSeleccionada) {
                const logged = localStorage.getItem('loggedUser');
                if (logged) {
                  const users = JSON.parse(localStorage.getItem('users') || '{}');
                  const user = users[logged];
                  if (user && Array.isArray(user.addresses) && user.addresses.length > 0) {
                    direccionSeleccionada = user.addresses[0];
                    // opcional: establecerla en localStorage para futuros usos
                    localStorage.setItem('direccion', direccionSeleccionada);
                  }
                }
              }

              if (!direccionSeleccionada || direccionSeleccionada.trim() === "") {
                alert('Debes ingresar una dirección para confirmar el pedido.');
                return Promise.reject(new Error('Dirección no registrada'));
              }

              const total = carritoLocal.reduce((s, i) => s + (Number(i.precio) || 0), 0);
              // PayPal espera valor en moneda configurada; aquí se usa USD (ajusta si necesario)
              const amountValue = total.toFixed(2);
              return actions.order.create({
                purchase_units: [{
                  amount: { value: amountValue, currency_code: 'USD' },
                  description: 'Pedido PEDIDOS YEMM'
                }]
              });
            } catch (err) {
              console.error('Error en createOrder:', err);
              return Promise.reject(err);
            }
          },

          onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
              try {
                const carritoLocal = JSON.parse(localStorage.getItem('carrito') || '[]');
                const email = localStorage.getItem('loggedUser') || 'invitado';
                const direccion = localStorage.getItem('direccion') || 'Sin dirección registrada';
                const total = carritoLocal.reduce((s, i) => s + (Number(i.precio) || 0), 0);
                const fecha = new Date().toLocaleString();

                const pedido = {
                  productos: carritoLocal,
                  total,
                  fecha,
                  direccion,
                  pago: 'paypal',
                  paypalOrderId: data.orderID,
                  comprador: details.payer || null
                };

                let pedidosPorUsuario = JSON.parse(localStorage.getItem('pedidosPorUsuario') || '{}');
                if (!pedidosPorUsuario[email]) pedidosPorUsuario[email] = [];
                pedidosPorUsuario[email].push(pedido);
                localStorage.setItem('pedidosPorUsuario', JSON.stringify(pedidosPorUsuario));

                let pedidosGlobales = JSON.parse(localStorage.getItem('pedidosGlobales') || '[]');
                pedidosGlobales.push({ cliente: email, productos: carritoLocal, total, fecha, direccion, estado: 'pagado', metodo: 'paypal', paypalOrderId: data.orderID });
                localStorage.setItem('pedidosGlobales', JSON.stringify(pedidosGlobales));

                // limpiar carrito correctamente (variable + localStorage + UI)
                carrito = [];
                localStorage.setItem('carrito', JSON.stringify([]));
                if (typeof actualizarCarrito === 'function') actualizarCarrito();

                alert('Pago completado. Gracias ' + ((details.payer && details.payer.name && details.payer.name.given_name) ? details.payer.name.given_name : '') + '!');
                bootstrap.Modal.getOrCreateInstance(document.getElementById('carritoModal')).hide();
                // quitar posibles backdrops y limpiar container PayPal
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                const container = document.getElementById('paypal-button-container');
                if (container) container.innerHTML = '';
                window.__paypalButtonsReady = false;
                window.__paypalButtonElement = null;
                document.body.classList.remove('modal-open');
              } catch (err) {
                console.error('Error guardando pedido en onApprove:', err);
                alert('Ocurrió un error al procesar el pedido. Revisa la consola.');
              }
            }).catch(err => {
              console.error('Error en capture():', err);
              alert('Error al capturar el pago. Revisa la consola.');
            });
          },

          onError: function (err) {
            console.error('PayPal onError:', err);
            alert('Error en el proceso de pago. Intenta de nuevo.');
          }
        }).render('#paypal-button-container').then(() => {
          window.__paypalButtonsReady = true;
          const container = document.getElementById('paypal-button-container');
          window.__paypalButtonElement = container && container.querySelector('button');
          console.info('PayPal Buttons renderizados y listos.');
        });
      })
      .catch(err => {
        console.error('initPayPalButtons fallo:', err);
        alert('Método de pago temporalmente no disponible. Revisa la consola (F12).');
        throw err;
      });
  }

  // Poll para buscar el botón interno de PayPal (intento de auto-click)
  function clickPaypalInternalButton(timeoutMs = 5000, intervalMs = 300) {
    return new Promise(resolve => {
      const start = Date.now();
      const iv = setInterval(() => {
        const container = document.getElementById('paypal-button-container');
        const btn = container && container.querySelector('button');
        if (btn) {
          clearInterval(iv);
          try { btn.click(); } catch (err) { console.warn('No se pudo clickear botón interno:', err); }
          return resolve(true);
        }
        if (Date.now() - start > timeoutMs) {
          clearInterval(iv);
          return resolve(false);
        }
      }, intervalMs);
    });
  }

  // Manejo cruzado de modales para evitar superposición / PayPal quedando detrás
  (function setupModalInteraction() {
    const carritoModalEl = document.getElementById('carritoModal');
    const direccionModalEl = document.getElementById('direccionModal');
    const paypalContainer = document.getElementById('paypal-button-container');

    // Cuando se muestra carrito, ocultar dirección y limpiar posibles backdrops
    if (carritoModalEl) {
      carritoModalEl.addEventListener('show.bs.modal', function () {
        if (direccionModalEl) {
          const instDir = bootstrap.Modal.getOrCreateInstance(direccionModalEl);
          try { instDir.hide(); } catch (e) { /* ignore */ }
        }
        // limpiar backdrops anteriores
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });

      carritoModalEl.addEventListener('shown.bs.modal', function () {
        // inicializar PayPal
        initPayPalButtons().catch(() => { /* ya notifica al usuario en init */ });
      });

      carritoModalEl.addEventListener('hidden.bs.modal', function () {
        // limpiar container PayPal y backdrops al cerrar carrito
        if (paypalContainer) paypalContainer.innerHTML = '';
        window.__paypalButtonsReady = false;
        window.__paypalButtonElement = null;
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });
    }

    // Cuando se muestra direccion, ocultar carrito y limpiar PayPal
    if (direccionModalEl) {
      direccionModalEl.addEventListener('show.bs.modal', function () {
        if (carritoModalEl) {
          const instCar = bootstrap.Modal.getOrCreateInstance(carritoModalEl);
          try { instCar.hide(); } catch (e) { /* ignore */ }
        }
        if (paypalContainer) paypalContainer.innerHTML = '';
        window.__paypalButtonsReady = false;
        window.__paypalButtonElement = null;
        // limpiar backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });

      direccionModalEl.addEventListener('hidden.bs.modal', function () {
        // limpieza adicional al cerrar dirección
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
      });
    }

    // Abrir modal dirección desde toast: asegurarse que carrito esté cerrado
    const abrirBtn = document.getElementById('abrirDireccionFromToast');
    if (abrirBtn) {
      abrirBtn.addEventListener('click', function () {
        if (carritoModalEl) {
          const instCar = bootstrap.Modal.getOrCreateInstance(carritoModalEl);
          try { instCar.hide(); } catch (e) { /* ignore */ }
        }
        bootstrap.Modal.getOrCreateInstance(direccionModalEl).show();
        const t = bootstrap.Toast.getInstance(document.getElementById('toastNoDireccion'));
        if (t) t.hide();
      });
    }
  })();

  // Handler para guardar/editar/eliminar dirección desde el modal
  (function handleDireccionForm() {
    const direccionForm = document.getElementById('direccionForm') || document.querySelector('#direccionModal form');
    if (!direccionForm) return;

    const direccionModalEl = document.getElementById('direccionModal');
    const guardarBtn = document.getElementById('guardarDireccionBtn');
    const eliminarBtn = document.getElementById('eliminarDireccionBtn');

    // Actualiza la lista de direcciones en el modal de perfil si está abierto
    function refreshProfileAddressesUI() {
      const logged = localStorage.getItem('loggedUser');
      if (!logged) return;
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[logged];
      if (!user) return;
      const ul = document.getElementById('profileAddresses');
      if (!ul) return;
      ul.innerHTML = '';
      const addresses = user.addresses || [];
      if (addresses.length === 0) {
        ul.innerHTML = '<li class="list-group-item">No hay direcciones registradas.</li>';
      } else {
        addresses.forEach(addr => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = addr;
          ul.appendChild(li);
        });
      }
    }

    // Rellenar formulario si ya existe dirección guardada
    function prefillDireccion() {
      const obj = JSON.parse(localStorage.getItem('direccionObj') || 'null');
      const texto = localStorage.getItem('direccion') || '';
      if (obj) {
        document.getElementById('calle').value = obj.calle || '';
        document.getElementById('ciudad').value = obj.ciudad || '';
        document.getElementById('departamento').value = obj.departamento || '';
        document.getElementById('codigoPostal').value = obj.codigoPostal || '';
        if (guardarBtn) guardarBtn.textContent = 'Actualizar Dirección';
        if (eliminarBtn) eliminarBtn.style.display = 'inline-block';
      } else if (texto) {
        // si sólo hay texto, mostrarlo en calle para edición rápida
        document.getElementById('calle').value = texto;
        document.getElementById('ciudad').value = '';
        document.getElementById('departamento').value = '';
        document.getElementById('codigoPostal').value = '';
        if (guardarBtn) guardarBtn.textContent = 'Actualizar Dirección';
        if (eliminarBtn) eliminarBtn.style.display = 'inline-block';
      } else {
        // no hay dirección registrada -> limpiar formulario
        document.getElementById('calle').value = '';
        document.getElementById('ciudad').value = '';
        document.getElementById('departamento').value = '';
        document.getElementById('codigoPostal').value = '';
        if (guardarBtn) guardarBtn.textContent = 'Guardar Dirección';
        if (eliminarBtn) eliminarBtn.style.display = 'none';
      }
    }

    // Al abrir el modal, rellenar si corresponde
    if (direccionModalEl) {
      direccionModalEl.addEventListener('show.bs.modal', function () {
        prefillDireccion();
      });
    }

    direccionForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const calle = document.getElementById('calle').value.trim();
      const ciudad = document.getElementById('ciudad').value.trim();
      const departamento = document.getElementById('departamento').value.trim();
      const codigoPostal = document.getElementById('codigoPostal').value.trim();

      if (!calle || !ciudad) {
        alert('Por favor completa calle y ciudad.');
        return;
      }

      const direccionTexto = `${calle}, ${ciudad}${departamento ? ', ' + departamento : ''}${codigoPostal ? ' - CP ' + codigoPostal : ''}`;
      const direccionObj = { calle, ciudad, departamento, codigoPostal };

      // Guardar tanto texto como objeto estructurado
      localStorage.setItem('direccion', direccionTexto);
      localStorage.setItem('direccionObj', JSON.stringify(direccionObj));

      // si hay usuario logueado, guardarla en su perfil (array addresses) evitando duplicados
      const logged = localStorage.getItem('loggedUser');
      if (logged) {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        if (!users[logged]) users[logged] = {};
        users[logged].addresses = users[logged].addresses || [];
        // evitar duplicados exactos
        if (!users[logged].addresses.includes(direccionTexto)) {
          users[logged].addresses.push(direccionTexto);
        }
        localStorage.setItem('users', JSON.stringify(users));
      }

      // cerrar modal y limpiar backdrop si quedó
      bootstrap.Modal.getOrCreateInstance(document.getElementById('direccionModal')).hide();
      document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      document.body.classList.remove('modal-open');

      // actualizar UI del perfil si corresponde
      refreshProfileAddressesUI();

      alert('Dirección guardada.');
    });

    // Eliminar dirección registrada
    if (eliminarBtn) {
      eliminarBtn.addEventListener('click', function () {
        const confirmDel = confirm('¿Deseas eliminar la dirección registrada?');
        if (!confirmDel) return;

        const direccionTexto = localStorage.getItem('direccion') || '';
        localStorage.removeItem('direccion');
        localStorage.removeItem('direccionObj');

        // si hay usuario logueado, eliminar la dirección del perfil (si coincide)
        const logged = localStorage.getItem('loggedUser');
        if (logged) {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          if (users[logged] && Array.isArray(users[logged].addresses)) {
            users[logged].addresses = users[logged].addresses.filter(a => a !== direccionTexto);
            localStorage.setItem('users', JSON.stringify(users));
          }
        }

        // limpiar formulario y ocultar botón eliminar
        document.getElementById('calle').value = '';
        document.getElementById('ciudad').value = '';
        document.getElementById('departamento').value = '';
        document.getElementById('codigoPostal').value = '';
        if (guardarBtn) guardarBtn.textContent = 'Guardar Dirección';
        eliminarBtn.style.display = 'none';

        // actualizar UI del perfil si corresponde
        refreshProfileAddressesUI();

        alert('Dirección eliminada.');
      });
    }
  })();

  // ConfirmarPedido: abrir modal + tratar de auto-click (mejorado y con espera) + validación de dirección
  (function attachConfirm() {
    const confirmarEl = document.getElementById('confirmarPedidoBtn');
    if (!confirmarEl) return;
    // remove previous listeners safely
    const nuevo = confirmarEl.cloneNode(true);
    confirmarEl.parentNode.replaceChild(nuevo, confirmarEl);

    nuevo.addEventListener('click', async function (e) {
      e.preventDefault();
      if (!Array.isArray(carrito) || carrito.length === 0) {
        alert('Tu carrito está vacío.');
        return;
      }

      // VALIDACIÓN: verificar si existe dirección (localStorage o en perfil del usuario)
      const direccionLocal = localStorage.getItem('direccion');
      let tieneDireccion = Boolean(direccionLocal && direccionLocal.trim());

      if (!tieneDireccion) {
        const logged = localStorage.getItem('loggedUser');
        if (logged) {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          const user = users[logged];
          if (user && Array.isArray(user.addresses) && user.addresses.length > 0) {
            tieneDireccion = true;
            // opcional: establecer la primera como dirección activa
            localStorage.setItem('direccion', user.addresses[0]);
          }
        }
      }

      if (!tieneDireccion) {
        // mostrar toast de aviso y no continuar con el flujo de pago
        const toastEl = document.getElementById('toastNoDireccion');
        const toast = new bootstrap.Toast(toastEl, { delay: 6000 });
        toast.show();
        return;
      }

      // abrir modal carrito (se encargará de inicializar PayPal y ocultar dirección)
      bootstrap.Modal.getOrCreateInstance(document.getElementById('carritoModal')).show();

      // asegurarse de que PayPal Buttons se inicialicen
      try {
        await initPayPalButtons();
        // espera y trata de clickear el botón interno (si existe)
        const clicked = await clickPaypalInternalButton(5000, 300);
        if (!clicked) {
          // no forzar, pedir al usuario que pulse
          console.info('No se encontró el botón interno de PayPal para auto-click; solicita al usuario pulsar el botón.');
        }
      } catch (err) {
        console.warn('No fue posible inicializar PayPal para auto-click:', err);
      }
    });
  })();
</script>
</body>
</html>